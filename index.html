<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¹¿ä¸œéº»å°† - æ— ä¸è‰¯å½±å“</title>
    <style>
        :root {
            --player-tile-w: 52px;
            --player-tile-h: 76px;
            --ai-tile-w: 40px;
            --ai-tile-h: 58px;
            --discard-tile-w: 38px;
            --discard-tile-h: 56px;
            --meld-tile-w: 34px;
            --meld-tile-h: 48px;
            --gap: 8px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            background: #0b5f3c;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 10px;
        }
        
        header {
            padding: 12px;
            text-align: center;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .main-container {
            display: flex;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
        }
        
        .table-section {
            flex: 4;
            display: flex;
            justify-content: center;
        }
        
        .table-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .table {
            width: 100%;
            height: 900px;
            background: linear-gradient(180deg, #1b6b49, #0b4f36);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            border: 3px solid #d4af37;
        }
        
        .info-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-width: 280px;
            max-width: 350px;
            width: 100%;
        }
        
        /* å¬ç‰Œä¿¡æ¯æ æ ·å¼ */
        .tingpai-panel {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: none;
            width: 100%;
        }
        
        .tingpai-panel.active {
            display: block;
        }
        
        .tingpai-title {
            font-size: 14px;
            color: #ffd66b;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .tingpai-tiles {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }
        
        .tingpai-tile {
            width: 35px;
            height: 50px;
            background: #fff;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .tingpai-tile .num {
            font-size: 12px;
        }
        
        .tingpai-tile .suit {
            font-size: 8px;
            color: #b00;
        }
        
        .tingpai-tile.honor {
            font-size: 14px;
            color: #000;
        }
        
        .tingpai-tile.red-dragon {
            color: #f00;
            background: #fff5f5;
        }
        
        .rules-btn {
            background: #4CAF50;
            color: white;
            margin-bottom: 15px;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            font-size: 16px;
        }
        
        .rules-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .scoreboard {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 100%;
        }
        
        .player-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .player-box.active {
            background: rgba(255, 215, 107, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 107, 0.5);
        }
        
        .hand {
            display: flex;
            gap: var(--gap);
            align-items: end;
        }
        
        .hand.vertical {
            flex-direction: column;
            align-items: center;
        }
        
        /* æ‰‹æœºç«¯å—ç©å®¶æ‰‹ç‰Œæ»‘åŠ¨æµè§ˆæ ·å¼ */
        #hand-0.mobile-slider {
            display: flex;
            flex-direction: row;
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 8px 0 15px 0;
            justify-content: flex-start;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: #ffd66b rgba(255, 255, 255, 0.1);
            /* ç¡®ä¿æ‰‹ç‰ŒåŒºåŸŸå¯ä»¥å®Œå…¨æ»šåŠ¨ */
            max-width: 100vw;
            margin-left: -5px;
            margin-right: -5px;
            padding-left: 5px;
            padding-right: 5px;
        }
        
        /* ä¸ºæ»‘åŠ¨å®¹å™¨æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        #hand-0.mobile-slider::-webkit-scrollbar {
            height: 6px;
        }
        
        #hand-0.mobile-slider::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        #hand-0.mobile-slider::-webkit-scrollbar-thumb {
            background: #ffd66b;
            border-radius: 3px;
        }
        
        /* ä¼˜åŒ–æ‰‹æœºç«¯è§¦æ‘¸åŒºåŸŸ */
        .tile {
            width: var(--player-tile-w);
            height: var(--player-tile-h);
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: 111;
            font-weight: 700;
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            flex-shrink: 0;
            margin: 0 2px;
            scroll-snap-align: start;
        }
        
        .tile:hover {
            transform: translateY(-4px);
        }
        
        .tile .num {
            font-size: 18px;
            color: #000;
        }
        
        .tile .suit {
            font-size: 11px;
            color: #b00;
        }
        
        .tile.honor {
            font-size: 20px;
            color: #000;
        }
        
        .tile.red-dragon {
            color: #f00;
            background: #fff5f5;
        }
        
        .tile.discarded {
            opacity: 0.7;
        }
        
        .tile.available {
            box-shadow: 0 0 0 2px #ffd66b;
        }
        
        .tile.new-draw {
            box-shadow: 0 0 0 3px #ff6b6b, 0 0 10px 3px rgba(255, 107, 107, 0.5);
            animation: pulse 1.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
        
        .ai-tile {
            width: var(--ai-tile-w);
            height: var(--ai-tile-h);
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
            user-select: none;
        }
        
        .ai-tile .num {
            font-size: 14px;
        }
        
        .ai-tile .suit {
            font-size: 9px;
            color: #b00;
        }
        
        .ai-tile.honor {
            font-size: 16px;
            color: #000;
        }
        
        .ai-tile.red-dragon {
            color: #f00;
            background: #fff5f5;
        }
        
        .discard-tile {
            width: var(--discard-tile-w);
            height: var(--discard-tile-h);
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
            user-select: none;
        }
        
        .discard-tile .num {
            font-size: 14px;
        }
        
        .discard-tile .suit {
            font-size: 9px;
            color: #b00;
        }
        
        .discard-tile.honor {
            font-size: 16px;
            color: #000;
        }
        
        .discard-tile.red-dragon {
            color: #f00;
            background: #fff5f5;
        }
        
        .meld {
            display: flex;
            gap: 2px;
            margin: 4px 0;
        }
        
        .meld-tile {
            width: var(--meld-tile-w);
            height: var(--meld-tile-h);
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
            user-select: none;
        }
        
        .meld-tile .num {
            font-size: 12px;
            transform: none !important;
        }
        
        .meld-tile .suit {
            font-size: 8px;
            color: #b00;
            transform: none !important;
        }
        
        .meld-tile.honor {
            font-size: 14px;
            color: #000;
        }
        
        .meld-tile.red-dragon {
            color: #f00;
            background: #fff5f5;
        }
        
        .melds-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            position: absolute;
            z-index: 5;
        }
        
        #melds-0 {
            bottom: 120px;
            right: 50px;
            flex-direction: row;
        }
        
        #melds-1 {
            top: 50px;
            right: 120px;
            flex-direction: column;
        }
        
        #melds-2 {
            top: 120px;
            left: 50px;
            flex-direction: row;
        }
        
        #melds-3 {
            bottom: 50px;
            left: 120px;
            flex-direction: column;
        }
        
        .back {
            background: #999 !important;
        }
        
        .controls {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: #ffd66b;
            color: #111;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            font-size: 14px;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        button:hover {
            background: #ffc83d;
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        button.win {
            background: #ff6b6b;
            color: white;
        }
        
        button.win:hover {
            background: #ff5252;
        }
        
        button.action {
            background: #6bcaff;
            color: white;
        }
        
        button.action:hover {
            background: #52b0ff;
        }
        
        button.dev-mode {
            background: #9b59b6;
            color: white;
        }
        
        button.dev-mode:hover {
            background: #8e44ad;
        }
        
        button.dev-mode.active {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        
        .info-panel {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            margin-top: 15px;
            width: 100%;
        }
        
        .log {
            height: 100px;
            overflow: auto;
            background: rgba(255, 255, 255, 0.08);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .log p {
            margin: 4px 0;
            line-height: 1.3;
        }
        
        /* ä¼˜åŒ–ç‰Œå¢™æ˜¾ç¤º */
        .pile {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 55px;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .seat {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .seat.top {
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: column;
        }
        
        .seat.bottom {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: column;
            width: 90%;
        }
        
        .seat.left {
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
        }
        
        .seat.right {
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
        }
        
        .seat.left .hand,
        .seat.right .hand {
            flex-direction: column;
            align-items: center;
        }
        
        .seat.left .ai-tile,
        .seat.right .ai-tile {
            width: var(--ai-tile-h);
            height: var(--ai-tile-w);
        }
        
        .seat.left .ai-tile .num,
        .seat.right .ai-tile .num {
            transform: rotate(90deg);
        }
        
        .seat.left .ai-tile .suit,
        .seat.right .ai-tile .suit {
            transform: rotate(90deg);
        }
        
        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }
        
        .center h4 {
            margin: 4px 0;
            color: #ffd;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            font-size: 14px;
        }
        
        .win-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(255, 215, 107, 0.7);
            border: 2px solid #ffd66b;
            display: none;
        }
        
        .win-message h2 {
            color: #ffd66b;
            margin-top: 0;
            font-size: 22px;
        }
        
        .win-message p {
            font-size: 16px;
            margin: 10px 0;
        }
        
        .win-message button {
            margin-top: 10px;
            padding: 10px 18px;
            font-size: 14px;
        }
        
        .countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffd66b;
            font-size: 36px;
            font-weight: bold;
            padding: 15px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(255, 215, 107, 0.4);
            display: none;
        }
        
        .action-prompt {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 0 15px rgba(255, 215, 107, 0.5);
            border: 2px solid #ffd66b;
            color: #ffd66b;
            font-weight: bold;
            display: none;
        }
        
        .win-prompt {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 200, 0, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1002;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
            border: 2px solid #00ff00;
            color: #fff;
            font-weight: bold;
            font-size: 20px;
            display: none;
            animation: winPulse 1s infinite alternate;
        }
        
        @keyframes winPulse {
            from { transform: translateX(-50%) scale(1); }
            to { transform: translateX(-50%) scale(1.05); }
        }
        
        .dev-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.5);
            border: 2px solid #9b59b6;
            z-index: 1003;
            display: none;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            cursor: move;
        }
        
        .dev-panel.active {
            display: block;
        }
        
        .dev-panel h3 {
            color: #9b59b6;
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            cursor: move;
            user-select: none;
        }
        
        .tile-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .dev-tile {
            width: 40px;
            height: 56px;
            background: #fff;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dev-tile:hover {
            transform: scale(1.1);
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        .dev-tile .num {
            font-size: 14px;
        }
        
        .dev-tile .suit {
            font-size: 9px;
            color: #b00;
        }
        
        .dev-tile.honor {
            font-size: 16px;
        }
        
        .dev-tile.red-dragon {
            color: #f00;
            background: #fff5f5;
        }
        
        .dev-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .dev-controls button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .dev-info {
            font-size: 12px;
            color: #ccc;
            margin-top: 10px;
            text-align: center;
        }
        
        /* è§„åˆ™æ¨¡æ€æ¡†æ ·å¼ */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        
        .rules-content {
            background: white;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .rules-content img {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }
        
        .close-rules {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 2001;
        }
        
        .close-rules:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        
        /* æ‰‹æœºç«¯å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            /* å—ç©å®¶ï¼ˆè‡ªå·±ï¼‰çš„æ‰‹ç‰Œå°ºå¯¸ */
            :root {
                --player-tile-w: 36px;
                --player-tile-h: 52px;
                /* å…¶ä»–ç©å®¶çš„æ‰‹ç‰Œå°ºå¯¸è¿›ä¸€æ­¥ç¼©å° */
                --ai-tile-w: 24px;
                --ai-tile-h: 35px;
                --discard-tile-w: 22px;
                --discard-tile-h: 32px;
                --meld-tile-w: 20px;
                --meld-tile-h: 28px;
                --gap: 2px;
            }
            
            body {
                padding: 5px;
            }
            
            header {
                padding: 8px;
                margin-bottom: 5px;
            }
            
            header h1 {
                font-size: 18px;
            }
            
            header p {
                font-size: 12px;
            }
            
            .main-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .table {
                height: 550px;
                padding: 15px 10px 85px 10px; /* åº•éƒ¨å¢åŠ å†…è¾¹è·ä¸ºå—ç©å®¶è…¾ç©ºé—´ */
            }
            
            .table-container {
                width: 100%;
            }
            
            .seat.top {
                top: 10px;
            }
            
            .seat.bottom {
                bottom: 10px;
                width: 95%;
            }
            
            .seat.left {
                left: 10px;
            }
            
            .seat.right {
                right: 10px;
            }
            
            .seat div:first-child {
                font-size: 12px;
            }
            
            .center h4 {
                font-size: 11px;
            }
            
            .center {
                transform: translate(-50%, -50%) scale(0.8);
            }
            
            #melds-0 {
                bottom: 60px;
                right: 20px;
            }
            
            #melds-1 {
                top: 20px;
                right: 60px;
            }
            
            #melds-2 {
                top: 60px;
                left: 20px;
            }
            
            #melds-3 {
                bottom: 20px;
                left: 60px;
            }
            
            .info-section {
                min-width: unset;
                max-width: unset;
                width: 100%;
            }
            
            .tingpai-panel {
                padding: 8px 12px;
            }
            
            .tingpai-title {
                font-size: 12px;
            }
            
            .tingpai-tile {
                width: 28px;
                height: 40px;
            }
            
            .tingpai-tile .num {
                font-size: 10px;
            }
            
            .tingpai-tile .suit {
                font-size: 7px;
            }
            
            .tingpai-tile.honor {
                font-size: 12px;
            }
            
            /* è§„åˆ™æŒ‰é’®å®½åº¦é€‚é… - æ”¹ä¸ºå±å¹•å®½åº¦çš„ä¸€åŠå·¦å³ */
            .rules-btn {
                padding: 12px 10px;
                font-size: 15px;
                margin-bottom: 12px;
                border-radius: 8px;
                width: 50%; /* æ”¹ä¸º50%å®½åº¦ */
                margin-left: auto;
                margin-right: auto;
                display: block;
            }
            
            .scoreboard {
                padding: 10px;
                width: 100%;
            }
            
            .player-box {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .info-panel {
                padding: 8px;
                width: 100%;
            }
            
            .controls {
                gap: 4px;
            }
            
            button {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .log {
                height: 80px;
                padding: 8px;
                font-size: 11px;
            }
            
            .tile .num {
                font-size: 14px;
            }
            
            .tile .suit {
                font-size: 9px;
            }
            
            .tile.honor {
                font-size: 16px;
            }
            
            .ai-tile .num {
                font-size: 10px;
            }
            
            .ai-tile .suit {
                font-size: 7px;
            }
            
            .ai-tile.honor {
                font-size: 12px;
            }
            
            .discard-tile .num {
                font-size: 10px;
            }
            
            .discard-tile .suit {
                font-size: 7px;
            }
            
            .discard-tile.honor {
                font-size: 12px;
            }
            
            .meld-tile .num {
                font-size: 9px;
            }
            
            .meld-tile .suit {
                font-size: 6px;
            }
            
            .meld-tile.honor {
                font-size: 10px;
            }
            
            .win-message {
                padding: 15px;
                width: 90%;
            }
            
            .win-message h2 {
                font-size: 18px;
            }
            
            .win-message p {
                font-size: 14px;
            }
            
            .win-message button {
                padding: 8px 14px;
                font-size: 12px;
            }
            
            .countdown {
                font-size: 28px;
                width: 50px;
                height: 50px;
            }
            
            .action-prompt {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .win-prompt {
                padding: 10px 15px;
                font-size: 16px;
            }
            
            .dev-panel {
                max-width: 250px;
                max-height: 350px;
                padding: 10px;
                bottom: 10px;
                right: 10px;
            }
            
            .dev-tile {
                width: 32px;
                height: 45px;
            }
            
            .dev-tile .num {
                font-size: 11px;
            }
            
            .dev-tile .suit {
                font-size: 7px;
            }
            
            .dev-tile.honor {
                font-size: 13px;
            }
            
            .dev-controls button {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .dev-info {
                font-size: 10px;
            }
            
            /* æ‰‹æœºç«¯å—ç©å®¶æ‰‹ç‰Œæ»‘åŠ¨æµè§ˆæ ·å¼ä¼˜åŒ– */
            #hand-0.mobile-slider {
                display: flex;
                flex-direction: row;
                width: 100%;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 8px 0 15px 0;
                justify-content: flex-start;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                position: relative;
                scrollbar-width: thin;
                scrollbar-color: #ffd66b rgba(255, 255, 255, 0.1);
                /* ç¡®ä¿æ‰‹ç‰ŒåŒºåŸŸå¯ä»¥å®Œå…¨æ»šåŠ¨ */
                max-width: 100vw;
                margin-left: -5px;
                margin-right: -5px;
                padding-left: 5px;
                padding-right: 5px;
            }
            
            /* ä¸ºæ»‘åŠ¨å®¹å™¨æ·»åŠ è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
            #hand-0.mobile-slider::-webkit-scrollbar {
                height: 6px;
            }
            
            #hand-0.mobile-slider::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
            }
            
            #hand-0.mobile-slider::-webkit-scrollbar-thumb {
                background: #ffd66b;
                border-radius: 3px;
            }
            
            /* ä¼˜åŒ–æ‰‹æœºç«¯è§¦æ‘¸åŒºåŸŸ */
            .tile {
                min-width: var(--player-tile-w);
                min-height: var(--player-tile-h);
                flex-shrink: 0;
                margin: 0 1px;
                scroll-snap-align: start;
            }
            
            /* æ·»åŠ æ»‘åŠ¨æç¤º */
            #hand-0.mobile-slider::after {
                content: "â† æ»‘åŠ¨æµè§ˆæ‰€æœ‰æ‰‹ç‰Œ â†’";
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                font-size: 10px;
                color: #ffd66b;
                white-space: nowrap;
                background: rgba(0, 0, 0, 0.7);
                padding: 2px 8px;
                border-radius: 10px;
                pointer-events: none;
            }
        }
        
        /* è¶…å°å±å¹•æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 480px) {
            /* å—ç©å®¶ï¼ˆè‡ªå·±ï¼‰çš„æ‰‹ç‰Œå°ºå¯¸è¿›ä¸€æ­¥ç¼©å° */
            :root {
                --player-tile-w: 32px;
                --player-tile-h: 47px;
                /* å…¶ä»–ç©å®¶çš„æ‰‹ç‰Œå°ºå¯¸è¿›ä¸€æ­¥ç¼©å° */
                --ai-tile-w: 22px;
                --ai-tile-h: 32px;
                --discard-tile-w: 20px;
                --discard-tile-h: 29px;
                --meld-tile-w: 18px;
                --meld-tile-h: 26px;
                --gap: 1px;
            }
            
            .table {
                height: 500px;
                padding-bottom: 80px;
            }
            
            .seat.top {
                top: 5px;
            }
            
            .seat.bottom {
                bottom: 5px;
            }
            
            .seat.left {
                left: 5px;
            }
            
            .seat.right {
                right: 5px;
            }
            
            .seat div:first-child {
                font-size: 10px;
            }
            
            #melds-0 {
                bottom: 50px;
                right: 15px;
            }
            
            #melds-1 {
                top: 15px;
                right: 50px;
            }
            
            #melds-2 {
                top: 50px;
                left: 15px;
            }
            
            #melds-3 {
                bottom: 15px;
                left: 50px;
            }
            
            .tingpai-tile {
                width: 24px;
                height: 34px;
            }
            
            .tingpai-tile .num {
                font-size: 8px;
            }
            
            .tingpai-tile .suit {
                font-size: 6px;
            }
            
            .tingpai-tile.honor {
                font-size: 10px;
            }
            
            /* è¶…å°å±å¹•ä¸‹è§„åˆ™æŒ‰é’®å®½åº¦è°ƒæ•´ä¸º60% */
            .rules-btn {
                padding: 10px 8px;
                font-size: 14px;
                margin-bottom: 10px;
                width: 60%; /* è¶…å°å±å¹•ä¸‹ç¨å¾®å®½ä¸€ç‚¹ */
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 200px;
            }
            
            /* è¿›ä¸€æ­¥è°ƒæ•´å—ç©å®¶æ‰‹ç‰Œå­—ä½“å¤§å° */
            .tile .num {
                font-size: 12px;
            }
            
            .tile .suit {
                font-size: 8px;
            }
            
            .tile.honor {
                font-size: 14px;
            }
            
            /* è¿›ä¸€æ­¥è°ƒæ•´å…¶ä»–ç©å®¶æ‰‹ç‰Œå­—ä½“å¤§å° */
            .ai-tile .num {
                font-size: 8px;
            }
            
            .ai-tile .suit {
                font-size: 6px;
            }
            
            .ai-tile.honor {
                font-size: 10px;
            }
            
            /* æ‰‹æœºç«¯å—ç©å®¶æ‰‹ç‰Œæ»‘åŠ¨æµè§ˆæ ·å¼ä¼˜åŒ– */
            #hand-0.mobile-slider {
                padding: 6px 0 12px 0;
            }
            
            #hand-0.mobile-slider::after {
                font-size: 9px;
            }
        }
        
        /* æ¨ªå±æ‰‹æœºä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            .main-container {
                flex-direction: row;
            }
            
            .table {
                height: 400px;
                padding-bottom: 70px;
            }
            
            .info-section {
                max-width: 250px;
            }
            
            /* æ¨ªå±æ—¶ç¨å¾®å¢å¤§æ‰‹ç‰Œå°ºå¯¸ */
            :root {
                --player-tile-w: 36px;
                --player-tile-h: 52px;
                --ai-tile-w: 28px;
                --ai-tile-h: 40px;
            }
            
            /* æ¨ªå±æ—¶è§„åˆ™æŒ‰é’®å®½åº¦è°ƒæ•´ */
            .rules-btn {
                width: 80%; /* æ¨ªå±æ—¶ç¨å¾®å®½ä¸€ç‚¹ */
            }
            
            /* æ¨ªå±æ—¶å—ç©å®¶æ‰‹ç‰Œæ»‘åŠ¨æµè§ˆä¼˜åŒ– */
            #hand-0.mobile-slider {
                max-height: 80px;
                padding: 5px 0 10px 0;
            }
            
            #hand-0.mobile-slider::after {
                font-size: 9px;
            }
        }
        
        /* å°å±å¹•å¹³æ¿ä¼˜åŒ– */
        @media (max-width: 1024px) and (min-width: 769px) {
            .table {
                height: 700px;
            }
            
            :root {
                --player-tile-w: 44px;
                --player-tile-h: 64px;
                --ai-tile-w: 32px;
                --ai-tile-h: 46px;
            }
            
            .rules-btn {
                width: 100%;
                padding: 12px 15px;
                font-size: 16px;
            }
        }
        
        /* æ¡Œé¢ç«¯ä¹Ÿç¡®ä¿è§„åˆ™æŒ‰é’®å®½åº¦ä¸€è‡´ */
        .rules-btn {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <header>
        <h1>å¹¿ä¸œéº»å°† - çº¢ä¸­å˜</h1>
        <p>æŠµåˆ¶ä¸è‰¯æ¸¸æˆï¼Œæ‹’ç»ç›—ç‰ˆæ¸¸æˆã€‚
æ³¨æ„è‡ªæˆ‘ä¿æŠ¤ï¼Œè°¨é˜²å—éª—ä¸Šå½“ã€‚
é€‚åº¦æ¸¸æˆç›Šè„‘ï¼Œæ²‰è¿·æ¸¸æˆä¼¤èº«ã€‚
åˆç†å®‰æ’æ—¶é—´ï¼Œäº«å—å¥åº·ç”Ÿæ´»ã€‚</p>
    </header>
    
    <div class="main-container">
        <div class="table-section">
            <div class="table-container">
                <div class="table">
                    <div class="seat top">
                        <div>åŒ—</div>
                        <div id="hand-2" class="hand"></div>
                        <div id="melds-2" class="melds-container"></div>
                    </div>
                    
                    <div class="seat bottom">
                        <div>å—ï¼ˆä½ ï¼‰</div>
                        <div id="hand-0" class="hand"></div>
                        <div id="melds-0" class="melds-container"></div>
                    </div>
                    
                    <div class="seat left">
                        <div>è¥¿</div>
                        <div id="hand-3" class="hand vertical"></div>
                        <div id="melds-3" class="melds-container"></div>
                    </div>
                    
                    <div class="seat right">
                        <div>ä¸œ</div>
                        <div id="hand-1" class="hand vertical"></div>
                        <div id="melds-1" class="melds-container"></div>
                    </div>
                    
                    <div class="center">
                        <h4>å¼ƒç‰Œå †</h4>
                        <div id="discards" class="pile"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-section">
            <!-- å¬ç‰Œä¿¡æ¯æ  -->
            <div id="tingpai-panel" class="tingpai-panel">
                <div class="tingpai-title">å¬ç‰Œä¸­ - å·®ä»¥ä¸‹ç‰Œå¯ä»¥èƒ¡ç‰Œï¼š</div>
                <div id="tingpai-tiles" class="tingpai-tiles"></div>
            </div>
            
            <!-- è§„åˆ™æŒ‰é’® -->
            <button id="btn-rules" class="rules-btn">æ¸¸æˆè§„åˆ™</button>
            
            <div class="scoreboard">
                <div class="player-box" id="score-0">å—ï¼ˆä½ ï¼‰ï¼š0</div>
                <div class="player-box" id="score-1">ä¸œï¼š0</div>
                <div class="player-box" id="score-2">åŒ—ï¼š0</div>
                <div class="player-box" id="score-3">è¥¿ï¼š0</div>
            </div>
            
            <div class="info-panel">
                <div class="controls">
                    <button id="btn-start">å¼€å§‹æ–°å±€</button>
                    <button id="btn-win" class="win" disabled>èƒ¡ç‰Œ</button>
                    <button id="btn-peng" class="action" style="display: none;">ç¢°</button>
                    <button id="btn-gang" class="action" style="display: none;">æ </button>
                    <button id="btn-skip" class="action" style="display: none;">è·³è¿‡</button>
                    <button id="btn-dev" class="dev-mode">å¼€å‘è€…æ¨¡å¼</button>
                </div>
                <div class="log" id="log">
                    <p>æ¸¸æˆå·²å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ–°å±€"æŒ‰é’®å¼€å§‹æ¸¸æˆã€‚</p>
                    <p>çº¢ä¸­å˜ç©æ³•ï¼šçº¢ä¸­å¯ä»¥ä½œä¸ºä¸‡èƒ½ç‰Œä½¿ç”¨ï¼Œä½†ä¸èƒ½ç”¨äºç¢°æˆ–æ ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div id="win-message" class="win-message">
        <h2>ç©å®¶ èƒ¡ç‰Œäº†ï¼</h2>
        <p>ç©å®¶ è·å¾— 10 åˆ†</p>
        <p>å½“å‰å¾—åˆ†: 0 | 0 | 0 | 0</p>
        <button id="btn-continue">ç»§ç»­æ¸¸æˆ</button>
    </div>

    <div id="countdown" class="countdown">10</div>
    <div id="action-prompt" class="action-prompt">è¯·é€‰æ‹©åŠ¨ä½œï¼ˆ10ç§’åè‡ªåŠ¨è·³è¿‡ï¼‰</div>
    <div id="win-prompt" class="win-prompt">ğŸ‰ ä½ å¯ä»¥èƒ¡ç‰Œäº†ï¼ç‚¹å‡»"èƒ¡ç‰Œ"æŒ‰é’®è·èƒœ ğŸ‰</div>

    <!-- è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="rules-modal" class="rules-modal">
        <div class="rules-content">
            <span class="close-rules">&times;</span>
            <img src="rules.png" alt="å¹¿ä¸œéº»å°†æ¸¸æˆè§„åˆ™" onerror="this.style.display='none'; document.getElementById('rules-fallback').style.display='block';">
            <div id="rules-fallback" style="display:none; padding: 20px; color: black; text-align: center;">
                <h3>è§„åˆ™å›¾ç‰‡åŠ è½½å¤±è´¥</h3>
                <p>è¯·ç¡®ä¿rules.pngå›¾ç‰‡æ–‡ä»¶ä½äºæ­£ç¡®çš„ä½ç½®</p>
                <h4>å¹¿ä¸œéº»å°†ï¼ˆçº¢ä¸­å˜ï¼‰åŸºæœ¬è§„åˆ™ï¼š</h4>
                <p>1. çº¢ä¸­å¯ä»¥ä½œä¸ºä¸‡èƒ½ç‰Œä½¿ç”¨</p>
                <p>2. çº¢ä¸­ä¸èƒ½ç”¨äºç¢°æˆ–æ </p>
                <p>3. æ¸¸æˆå¼€å§‹æ—¶åº„å®¶æœ‰14å¼ ç‰Œï¼Œå…¶ä»–ç©å®¶13å¼ </p>
                <p>4. ç©å®¶éœ€ç»„æˆ4ç»„é¡ºå­/åˆ»å­åŠ ä¸€å¯¹å°†ç‰Œå³å¯èƒ¡ç‰Œ</p>
                <p>5. å¯ä»¥ç¢°ã€æ å…¶ä»–ç©å®¶æ‰“å‡ºçš„ç‰Œ</p>
                <p>6. èƒ¡ç‰Œåè·å¾—10åˆ†</p>
            </div>
        </div>
    </div>

    <div id="dev-panel" class="dev-panel">
        <h3>å¼€å‘è€…æ¨¡å¼</h3>
        <div class="tile-palette" id="tile-palette"></div>
        <div class="dev-controls">
            <button id="btn-clear-hand">æ¸…ç©ºæ‰‹ç‰Œ</button>
            <button id="btn-test-win">æµ‹è¯•èƒ¡ç‰Œ</button>
            <button id="btn-add-random">éšæœºæ·»åŠ 5å¼ ç‰Œ</button>
            <button id="btn-add-red-dragon">æ·»åŠ çº¢ä¸­</button>
        </div>
        <div class="dev-info">
            <p>ç‚¹å‡»ç‰Œåº“ä¸­çš„ç‰Œæ·»åŠ åˆ°æ‰‹ç‰Œ</p>
            <p>ç‚¹å‡»æ‰‹ç‰Œå¯ä»æ‰‹ç‰Œä¸­ç§»é™¤</p>
        </div>
    </div>

    <script>
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        const PLAYER_NAMES = ['å—ï¼ˆä½ ï¼‰', 'ä¸œ', 'åŒ—', 'è¥¿'];
        const WIN_SCORE = 10;
        const REACTION_TIME = 10000;
        const WIN_PROMPT_TIME = 5000;
        
        const state = {
            wall: [],
            hands: [[], [], [], []],
            melds: [[], [], [], []],
            discards: [],
            currentPlayer: 0,
            lastDiscard: null,
            lastDiscardPlayer: -1,
            scores: [0, 0, 0, 0],
            waitingForDiscard: false,
            firstTurn: true,
            gameOver: false,
            availableActions: {
                peng: false,
                gang: false,
                gangAfterDraw: false,
                gangType: null,
                gangTile: null
            },
            reactionTimer: null,
            countdown: 10,
            isReacting: false,
            pendingAction: null,
            countdownInterval: null,
            hasActionBeenProcessed: false,
            skipPengGang: false,
            newDrawTileId: null,
            winPromptTimer: null,
            devMode: false,
            redDragonWildcard: true,
            tingPaiTiles: [] // æ–°å¢ï¼šå¬ç‰Œåˆ—è¡¨
        };
        
        const logEl = document.getElementById('log');
        const winBtn = document.getElementById('btn-win');
        const startBtn = document.getElementById('btn-start');
        const pengBtn = document.getElementById('btn-peng');
        const gangBtn = document.getElementById('btn-gang');
        const skipBtn = document.getElementById('btn-skip');
        const continueBtn = document.getElementById('btn-continue');
        const countdownEl = document.getElementById('countdown');
        const promptEl = document.getElementById('action-prompt');
        const winMessageEl = document.getElementById('win-message');
        const winPromptEl = document.getElementById('win-prompt');
        const devBtn = document.getElementById('btn-dev');
        const devPanel = document.getElementById('dev-panel');
        const tilePalette = document.getElementById('tile-palette');
        const clearHandBtn = document.getElementById('btn-clear-hand');
        const testWinBtn = document.getElementById('btn-test-win');
        const addRandomBtn = document.getElementById('btn-add-random');
        const addRedDragonBtn = document.getElementById('btn-add-red-dragon');
        
        // è§„åˆ™ç›¸å…³å…ƒç´ 
        const rulesBtn = document.getElementById('btn-rules');
        const rulesModal = document.getElementById('rules-modal');
        const closeRules = document.querySelector('.close-rules');
        
        // å¬ç‰Œç›¸å…³å…ƒç´ 
        const tingPaiPanel = document.getElementById('tingpai-panel');
        const tingPaiTilesEl = document.getElementById('tingpai-tiles');
        
        let isDragging = false;
        let dragOffsetX, dragOffsetY;
        
        // æ˜¾ç¤ºè§„åˆ™æ¨¡æ€æ¡†
        function showRules() {
            rulesModal.style.display = 'flex';
        }
        
        // éšè—è§„åˆ™æ¨¡æ€æ¡†
        function hideRules() {
            rulesModal.style.display = 'none';
        }
        
        // æ¸²æŸ“å¬ç‰Œä¿¡æ¯
        function renderTingPai() {
            tingPaiTilesEl.innerHTML = '';
            
            if (state.tingPaiTiles.length > 0) {
                tingPaiPanel.classList.add('active');
                
                for (const tile of state.tingPaiTiles) {
                    const tileEl = document.createElement('div');
                    tileEl.className = 'tingpai-tile';
                    
                    if (tile.type === 'honor' && tile.rank === 'red') {
                        tileEl.classList.add('red-dragon');
                    }
                    
                    if (tile.type === 'honor') {
                        tileEl.classList.add('honor');
                        tileEl.textContent = tileToChinese(tile);
                    } else {
                        const num = document.createElement('div');
                        num.className = 'num';
                        num.textContent = tile.rank;
                        
                        const suit = document.createElement('div');
                        suit.className = 'suit';
                        suit.innerHTML = (tile.suit === 'm' ? 'ä¸‡' : tile.suit === 'p' ? 'ç­’' : 'æ¡');
                        
                        tileEl.appendChild(num);
                        tileEl.appendChild(suit);
                    }
                    
                    tingPaiTilesEl.appendChild(tileEl);
                }
            } else {
                tingPaiPanel.classList.remove('active');
            }
        }
        
        // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
        function checkTingPai() {
            state.tingPaiTiles = [];
            
            // åªæœ‰å½“ç©å®¶æ‰‹ç‰Œæ˜¯3n+1å¼ æ—¶ï¼Œæ‰å¯èƒ½å¬ç‰Œ
            if (state.hands[0].length % 3 !== 1) {
                return;
            }
            
            // å°è¯•æ‰€æœ‰å¯èƒ½çš„ç‰Œï¼Œçœ‹åŠ å…¥åæ˜¯å¦èƒ½èƒ¡ç‰Œ
            const allTiles = makeAllTiles();
            const uniqueTiles = [];
            const seen = new Set();
            
            for (const tile of allTiles) {
                const id = tileId(tile);
                if (!seen.has(id)) {
                    seen.add(id);
                    uniqueTiles.push(tile);
                }
            }
            
            for (const tile of uniqueTiles) {
                // å¤åˆ¶å½“å‰æ‰‹ç‰Œ
                const testHand = [...state.hands[0], tile];
                
                // æ£€æŸ¥æ˜¯å¦èƒ½èƒ¡ç‰Œ
                if (checkWinConditionWithHand(testHand)) {
                    state.tingPaiTiles.push(tile);
                }
            }
            
            renderTingPai();
            
            if (state.tingPaiTiles.length > 0) {
                log(`å¬ç‰ŒçŠ¶æ€ï¼šå·® ${state.tingPaiTiles.map(t => tileToChinese(t)).join('ã€')} å¯ä»¥èƒ¡ç‰Œ`);
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šæ‰‹ç‰Œæ£€æŸ¥èƒ¡ç‰Œæ¡ä»¶
        function checkWinConditionWithHand(hand) {
            const n = (hand.length - 2) / 3;
            
            const counts = {};
            let redDragons = 0;
            
            for (const tile of hand) {
                if (state.redDragonWildcard && tile.type === 'honor' && tile.rank === 'red') {
                    redDragons++;
                } else {
                    const id = tileId(tile);
                    counts[id] = (counts[id] || 0) + 1;
                }
            }
            
            for (const id in counts) {
                if (counts[id] >= 2) {
                    const newCounts = {...counts};
                    newCounts[id] -= 2;
                    if (newCounts[id] === 0) delete newCounts[id];
                    
                    if (canFormMeldGroupsWithRedDragon(newCounts, redDragons, n)) {
                        return true;
                    }
                }
                
                if (counts[id] >= 1 && redDragons >= 1) {
                    const newCounts = {...counts};
                    newCounts[id] -= 1;
                    if (newCounts[id] === 0) delete newCounts[id];
                    
                    if (canFormMeldGroupsWithRedDragon(newCounts, redDragons - 1, n)) {
                        return true;
                    }
                }
            }
            
            if (redDragons >= 2) {
                if (canFormMeldGroupsWithRedDragon(counts, redDragons - 2, n)) {
                    return true;
                }
            }
            
            return false;
        }
        
        function canFormMeldGroupsWithRedDragon(counts, redDragons, n) {
            if (Object.keys(counts).length === 0 && redDragons === 0) return true;
            
            if (n === 0) return Object.keys(counts).length === 0 && redDragons === 0;
            
            const keys = Object.keys(counts);
            
            if (keys.length === 0) {
                if (redDragons >= 3) {
                    return canFormMeldGroupsWithRedDragon(counts, redDragons - 3, n - 1);
                }
                return false;
            }
            
            const firstKey = keys[0];
            
            const suit = firstKey[0];
            const rank = parseInt(firstKey.slice(1));
            
            if (counts[firstKey] >= 3) {
                const newCounts = {...counts};
                newCounts[firstKey] -= 3;
                if (newCounts[firstKey] === 0) delete newCounts[firstKey];
                
                if (canFormMeldGroupsWithRedDragon(newCounts, redDragons, n - 1)) {
                    return true;
                }
            }
            
            if (counts[firstKey] + redDragons >= 3) {
                const needRedDragons = Math.max(0, 3 - counts[firstKey]);
                const newCounts = {...counts};
                delete newCounts[firstKey];
                
                if (canFormMeldGroupsWithRedDragon(newCounts, redDragons - needRedDragons, n - 1)) {
                    return true;
                }
            }
            
            if (suit !== 'z' && rank <= 7) {
                const next1 = `${suit}${rank + 1}`;
                const next2 = `${suit}${rank + 2}`;
                
                const count1 = counts[next1] || 0;
                const count2 = counts[next2] || 0;
                
                if (counts[firstKey] > 0 && count1 > 0 && count2 > 0) {
                    const newCounts = {...counts};
                    newCounts[firstKey] -= 1;
                    newCounts[next1] -= 1;
                    newCounts[next2] -= 1;
                    
                    for (const key of [firstKey, next1, next2]) {
                        if (newCounts[key] === 0) delete newCounts[key];
                    }
                    
                    if (canFormMeldGroupsWithRedDragon(newCounts, redDragons, n - 1)) {
                        return true;
                    }
                }
                
                let missing = 0;
                if (counts[firstKey] === 0) missing++;
                if (count1 === 0) missing++;
                if (count2 === 0) missing++;
                
                if (redDragons >= missing) {
                    const newCounts = {...counts};
                    
                    if (counts[firstKey] > 0) {
                        newCounts[firstKey] -= 1;
                        if (newCounts[firstKey] === 0) delete newCounts[firstKey];
                    }
                    if (count1 > 0) {
                        newCounts[next1] -= 1;
                        if (newCounts[next1] === 0) delete newCounts[next1];
                    }
                    if (count2 > 0) {
                        newCounts[next2] -= 1;
                        if (newCounts[next2] === 0) delete newCounts[next2];
                    }
                    
                    if (canFormMeldGroupsWithRedDragon(newCounts, redDragons - missing, n - 1)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // ä¼˜åŒ–æ‰‹æœºç«¯è§¦æ‘¸äº‹ä»¶å¤„ç†
        function addTouchSupport() {
            // ä¸ºéº»å°†ç‰Œæ·»åŠ è§¦æ‘¸äº‹ä»¶
            document.addEventListener('touchstart', function(e) {
                // é˜²æ­¢è§¦æ‘¸æ—¶é¡µé¢æ»šåŠ¨
                if (e.target.classList.contains('tile') && 
                    !e.target.classList.contains('back') && 
                    state.currentPlayer === 0 && 
                    state.waitingForDiscard) {
                    e.preventDefault();
                    
                    // æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
                    if (e.target.click) {
                        e.target.click();
                    } else if (e.target.parentNode.click) {
                        e.target.parentNode.click();
                    }
                }
            }, { passive: false });
            
            // ä¸ºæŒ‰é’®æ·»åŠ è§¦æ‘¸äº‹ä»¶
            document.addEventListener('touchstart', function(e) {
                if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                    e.target.style.transform = 'translateY(-2px)';
                }
            });
            
            document.addEventListener('touchend', function(e) {
                if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                    e.target.style.transform = '';
                }
            });
            
            // å¢åŠ è§¦æ‘¸åŒºåŸŸï¼Œæé«˜çµæ•åº¦
            if (isMobile) {
                document.addEventListener('touchstart', function(e) {
                    const tile = e.target.closest('.tile');
                    if (tile && !tile.classList.contains('back') && 
                        state.currentPlayer === 0 && state.waitingForDiscard) {
                        tile.style.transform = 'translateY(-8px)';
                    }
                });
                
                document.addEventListener('touchend', function(e) {
                    const tile = e.target.closest('.tile');
                    if (tile && !tile.classList.contains('back')) {
                        tile.style.transform = '';
                    }
                });
            }
        }
        
        function initDevPanelDrag() {
            const devPanelHeader = devPanel.querySelector('h3');
            
            devPanelHeader.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            devPanelHeader.addEventListener('touchstart', startDragTouch);
            document.addEventListener('touchmove', dragTouch);
            document.addEventListener('touchend', stopDrag);
        }
        
        function startDrag(e) {
            isDragging = true;
            const rect = devPanel.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            devPanel.style.cursor = 'grabbing';
        }
        
        function startDragTouch(e) {
            isDragging = true;
            const touch = e.touches[0];
            const rect = devPanel.getBoundingClientRect();
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;
            devPanel.style.cursor = 'grabbing';
            e.preventDefault();
        }
        
        function drag(e) {
            if (!isDragging) return;
            
            devPanel.style.left = (e.clientX - dragOffsetX) + 'px';
            devPanel.style.top = (e.clientY - dragOffsetY) + 'px';
            devPanel.style.right = 'auto';
            devPanel.style.bottom = 'auto';
        }
        
        function dragTouch(e) {
            if (!isDragging) return;
            
            const touch = e.touches[0];
            devPanel.style.left = (touch.clientX - dragOffsetX) + 'px';
            devPanel.style.top = (touch.clientY - dragOffsetY) + 'px';
            devPanel.style.right = 'auto';
            devPanel.style.bottom = 'auto';
            e.preventDefault();
        }
        
        function stopDrag() {
            isDragging = false;
            devPanel.style.cursor = 'move';
        }
        
        function makeAllTiles() {
            const suits = ['m', 'p', 's'];
            const honors = ['east', 'south', 'west', 'north', 'red', 'green', 'white'];
            const tiles = [];
            
            for (const s of suits) {
                for (let r = 1; r <= 9; r++) {
                    for (let c = 0; c < 4; c++) {
                        tiles.push({
                            suit: s, 
                            rank: r, 
                            type: 'number',
                            id: `${s}${r}-${c}`
                        });
                    }
                }
            }
            
            for (const h of honors) {
                for (let c = 0; c < 4; c++) {
                    tiles.push({
                        suit: 'z', 
                        rank: h, 
                        type: 'honor',
                        id: `z${h}-${c}`
                    });
                }
            }
            
            return tiles;
        }
        
        function tileId(t) {
            return t.suit + (t.type === 'number' ? t.rank : t.rank);
        }
        
        function tileToChinese(t) {
            if (t.type === 'honor') {
                const honorMap = {
                    'east': 'ä¸œ',
                    'south': 'å—',
                    'west': 'è¥¿',
                    'north': 'åŒ—',
                    'red': 'ä¸­',
                    'green': 'å‘',
                    'white': 'ç™½'
                };
                return honorMap[t.rank];
            }
            
            const suitMap = {
                'm': 'ä¸‡',
                'p': 'ç­’',
                's': 'æ¡'
            };
            
            const numMap = {
                1: 'ä¸€',
                2: 'äºŒ',
                3: 'ä¸‰',
                4: 'å››',
                5: 'äº”',
                6: 'å…­',
                7: 'ä¸ƒ',
                8: 'å…«',
                9: 'ä¹'
            };
            
            return numMap[t.rank] + suitMap[t.suit];
        }
        
        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        
        function renderTile(t, opts = {}) {
            const el = document.createElement('div');
            el.className = opts.aiPlayer ? 'ai-tile' : 'tile';
            if (opts.back) el.classList.add('back');
            if (opts.discarded) el.classList.add('discarded');
            if (opts.available) el.classList.add('available');
            
            if (!opts.aiPlayer && !opts.back && state.newDrawTileId && 
                t.id === state.newDrawTileId) {
                el.classList.add('new-draw');
            }
            
            if (t.type === 'honor' && t.rank === 'red') {
                el.classList.add('red-dragon');
            }
            
            if (state.devMode && !opts.aiPlayer && !opts.back) {
                el.classList.add('dev-removable');
            }
            
            if (!opts.back) {
                if (t.type === 'honor') {
                    el.classList.add('honor');
                    el.textContent = tileToChinese(t);
                } else {
                    const num = document.createElement('div');
                    num.className = 'num';
                    num.textContent = t.rank;
                    
                    const suit = document.createElement('div');
                    suit.className = 'suit';
                    suit.innerHTML = (t.suit === 'm' ? 'ä¸‡' : t.suit === 'p' ? 'ç­’' : 'æ¡');
                    
                    el.appendChild(num);
                    el.appendChild(suit);
                }
            }
            
            // ä¼˜åŒ–è§¦æ‘¸äº‹ä»¶å¤„ç†
            if (opts.click) {
                el.addEventListener('click', opts.click);
                // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
                el.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    opts.click();
                });
            }
            
            return el;
        }
        
        function renderDevTile(t) {
            const el = document.createElement('div');
            el.className = 'dev-tile';
            
            if (t.type === 'honor' && t.rank === 'red') {
                el.classList.add('red-dragon');
            }
            
            if (t.type === 'honor') {
                el.classList.add('honor');
                el.textContent = tileToChinese(t);
            } else {
                const num = document.createElement('div');
                num.className = 'num';
                num.textContent = t.rank;
                
                const suit = document.createElement('div');
                suit.className = 'suit';
                suit.innerHTML = (t.suit === 'm' ? 'ä¸‡' : t.suit === 'p' ? 'ç­’' : 'æ¡');
                
                el.appendChild(num);
                el.appendChild(suit);
            }
            
            el.addEventListener('click', () => {
                if (state.devMode) {
                    const tileIndex = state.wall.findIndex(wallTile => 
                        wallTile.suit === t.suit && wallTile.rank === t.rank);
                    
                    if (tileIndex !== -1) {
                        const newTile = state.wall.splice(tileIndex, 1)[0];
                        state.hands[0].push(newTile);
                        sortHand(state.hands[0]);
                        renderAll();
                        checkWinCondition(0);
                        checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                        log(`å¼€å‘è€…æ¨¡å¼ï¼šæ·»åŠ  ${tileToChinese(t)} åˆ°æ‰‹ç‰Œ`);
                    } else {
                        log(`å¼€å‘è€…æ¨¡å¼ï¼šç‰Œåº“ä¸­æ²¡æœ‰ ${tileToChinese(t)} äº†`);
                    }
                }
            });
            
            return el;
        }
        
        function renderMeldTile(t) {
            const el = document.createElement('div');
            el.className = 'meld-tile';
            
            if (t.type === 'honor' && t.rank === 'red') {
                el.classList.add('red-dragon');
            }
            
            if (t.type === 'honor') {
                el.classList.add('honor');
                el.textContent = tileToChinese(t);
            } else {
                const num = document.createElement('div');
                num.className = 'num';
                num.textContent = t.rank;
                
                const suit = document.createElement('div');
                suit.className = 'suit';
                suit.innerHTML = (t.suit === 'm' ? 'ä¸‡' : t.suit === 'p' ? 'ç­’' : 'æ¡');
                
                el.appendChild(num);
                el.appendChild(suit);
            }
            
            return el;
        }
        
        function renderDiscardTile(t) {
            const el = document.createElement('div');
            el.className = 'discard-tile';
            
            if (t.type === 'honor' && t.rank === 'red') {
                el.classList.add('red-dragon');
            }
            
            if (t.type === 'honor') {
                el.classList.add('honor');
                el.textContent = tileToChinese(t);
            } else {
                const num = document.createElement('div');
                num.className = 'num';
                num.textContent = t.rank;
                
                const suit = document.createElement('div');
                suit.className = 'suit';
                suit.innerHTML = (t.suit === 'm' ? 'ä¸‡' : t.suit === 'p' ? 'ç­’' : 'æ¡');
                
                el.appendChild(num);
                el.appendChild(suit);
            }
            
            return el;
        }
        
        function log(s) {
            const p = document.createElement('p');
            p.textContent = s;
            logEl.prepend(p);
            logEl.scrollTop = 0;
        }
        
        function showCountdown() {
            state.countdown = 10;
            countdownEl.style.display = 'flex';
            countdownEl.textContent = state.countdown;
            
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
            }
            
            state.countdownInterval = setInterval(() => {
                state.countdown--;
                countdownEl.textContent = state.countdown;
                
                if (state.countdown <= 0) {
                    clearInterval(state.countdownInterval);
                    countdownEl.style.display = 'none';
                    state.countdown = 10;
                    hideActionButtons();
                    state.isReacting = false;
                    skipAction();
                }
            }, 1000);
        }
        
        function showActionPrompt() {
            promptEl.textContent = 'è¯·é€‰æ‹©åŠ¨ä½œï¼ˆ10ç§’åè‡ªåŠ¨è·³è¿‡ï¼‰';
            promptEl.style.display = 'block';
        }
        
        function hideActionPrompt() {
            promptEl.style.display = 'none';
        }
        
        function showWinPrompt() {
            winPromptEl.style.display = 'block';
            
            if (state.winPromptTimer) {
                clearTimeout(state.winPromptTimer);
            }
            
            state.winPromptTimer = setTimeout(() => {
                winPromptEl.style.display = 'none';
            }, WIN_PROMPT_TIME);
        }
        
        function hideWinPrompt() {
            winPromptEl.style.display = 'none';
            if (state.winPromptTimer) {
                clearTimeout(state.winPromptTimer);
                state.winPromptTimer = null;
            }
        }
        
        function toggleDevMode() {
            state.devMode = !state.devMode;
            
            if (state.devMode) {
                devBtn.classList.add('active');
                devPanel.classList.add('active');
                log('å¼€å‘è€…æ¨¡å¼å·²å¼€å¯');
                renderTilePalette();
            } else {
                devBtn.classList.remove('active');
                devPanel.classList.remove('active');
                log('å¼€å‘è€…æ¨¡å¼å·²å…³é—­');
            }
            
            renderAll();
        }
        
        function renderTilePalette() {
            tilePalette.innerHTML = '';
            
            const uniqueTiles = [];
            const seen = new Set();
            
            for (const tile of makeAllTiles()) {
                const id = tileId(tile);
                if (!seen.has(id)) {
                    seen.add(id);
                    uniqueTiles.push(tile);
                }
            }
            
            uniqueTiles.sort((a, b) => {
                if (a.type !== b.type) {
                    return a.type === 'number' ? -1 : 1;
                }
                
                if (a.suit !== b.suit) {
                    return a.suit.localeCompare(b.suit);
                }
                
                if (a.type === 'honor') {
                    const honorOrder = {
                        'east': 1, 'south': 2, 'west': 3, 'north': 4,
                        'red': 5, 'green': 6, 'white': 7
                    };
                    return honorOrder[a.rank] - honorOrder[b.rank];
                }
                
                return a.rank - b.rank;
            });
            
            for (const tile of uniqueTiles) {
                tilePalette.appendChild(renderDevTile(tile));
            }
        }
        
        function clearPlayerHand() {
            if (state.devMode) {
                state.wall.push(...state.hands[0]);
                state.hands[0] = [];
                renderAll();
                checkWinCondition(0);
                checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                log('å¼€å‘è€…æ¨¡å¼ï¼šæ¸…ç©ºæ‰‹ç‰Œï¼Œå·²æ”¾å›ç‰Œåº“');
            }
        }
        
        function testWinHand() {
            if (state.devMode) {
                const winHand = [
                    {suit: 'z', rank: 'red', type: 'honor', id: 'zred-test'},
                    {suit: 'm', rank: 1, type: 'number', id: 'm1-test'},
                    {suit: 'm', rank: 2, type: 'number', id: 'm2-test'},
                    {suit: 'm', rank: 3, type: 'number', id: 'm3-test'},
                    {suit: 'm', rank: 4, type: 'number', id: 'm4-test'},
                    {suit: 'm', rank: 5, type: 'number', id: 'm5-test'},
                    {suit: 'm', rank: 6, type: 'number', id: 'm6-test'},
                    {suit: 'm', rank: 7, type: 'number', id: 'm7-test'},
                    {suit: 'm', rank: 8, type: 'number', id: 'm8-test'},
                    {suit: 'm', rank: 9, type: 'number', id: 'm9-test'},
                    {suit: 'm', rank: 9, type: 'number', id: 'm9-test2'},
                    {suit: 'p', rank: 1, type: 'number', id: 'p1-test'},
                    {suit: 'p', rank: 1, type: 'number', id: 'p1-test2'},
                    {suit: 'p', rank: 1, type: 'number', id: 'p1-test3'}
                ];
                
                state.hands[0] = winHand;
                sortHand(state.hands[0]);
                renderAll();
                checkWinCondition(0);
                checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                log('å¼€å‘è€…æ¨¡å¼ï¼šè®¾ç½®æµ‹è¯•èƒ¡ç‰Œæ‰‹ç‰Œï¼ˆåŒ…å«çº¢ä¸­ï¼‰');
            }
        }
        
        function addRandomTiles() {
            if (state.devMode) {
                for (let i = 0; i < 5 && state.wall.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * state.wall.length);
                    const randomTile = state.wall.splice(randomIndex, 1)[0];
                    state.hands[0].push(randomTile);
                }
                sortHand(state.hands[0]);
                renderAll();
                checkWinCondition(0);
                checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                log('å¼€å‘è€…æ¨¡å¼ï¼šéšæœºæ·»åŠ 5å¼ ç‰Œåˆ°æ‰‹ç‰Œï¼ˆä»ç‰Œåº“æŠ½å–ï¼‰');
            }
        }
        
        function addRedDragon() {
            if (state.devMode) {
                const redDragonIndex = state.wall.findIndex(tile => 
                    tile.type === 'honor' && tile.rank === 'red');
                
                if (redDragonIndex !== -1) {
                    const redDragon = state.wall.splice(redDragonIndex, 1)[0];
                    state.hands[0].push(redDragon);
                    sortHand(state.hands[0]);
                    renderAll();
                    checkWinCondition(0);
                    checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                    log('å¼€å‘è€…æ¨¡å¼ï¼šæ·»åŠ çº¢ä¸­åˆ°æ‰‹ç‰Œï¼ˆä»ç‰Œåº“æŠ½å–ï¼‰');
                } else {
                    log('å¼€å‘è€…æ¨¡å¼ï¼šç‰Œåº“ä¸­æ²¡æœ‰çº¢ä¸­äº†');
                }
            }
        }
        
        function reset() {
            state.wall = shuffle(makeAllTiles());
            state.discards = [];
            state.lastDiscard = null;
            state.lastDiscardPlayer = -1;
            state.currentPlayer = 0;
            state.waitingForDiscard = true;
            state.firstTurn = true;
            state.gameOver = false;
            state.availableActions = { peng: false, gang: false, gangAfterDraw: false, gangType: null, gangTile: null };
            state.isReacting = false;
            state.pendingAction = null;
            state.countdown = 10;
            state.hasActionBeenProcessed = false;
            state.skipPengGang = false;
            state.newDrawTileId = null;
            state.tingPaiTiles = []; // é‡ç½®å¬ç‰Œåˆ—è¡¨
            
            if (state.reactionTimer) {
                clearTimeout(state.reactionTimer);
                state.reactionTimer = null;
            }
            
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
                state.countdownInterval = null;
            }
            
            countdownEl.style.display = 'none';
            hideActionPrompt();
            winMessageEl.style.display = 'none';
            hideWinPrompt();
            
            for (let i = 0; i < 4; i++) {
                state.hands[i] = [];
                state.melds[i] = [];
            }
            
            for (let round = 0; round < 3; round++) {
                for (let p = 0; p < 4; p++) {
                    for (let k = 0; k < 4; k++) {
                        state.hands[p].push(state.wall.pop());
                    }
                }
            }
            
            for (let p = 0; p < 4; p++) {
                state.hands[p].push(state.wall.pop());
            }
            
            state.hands[0].push(state.wall.pop());
            
            for (let p = 0; p < 4; p++) {
                sortHand(state.hands[p]);
            }
            
            updatePlayerHighlight();
            renderAll();
            checkWinCondition(0);
            checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
            hideActionButtons();
            log('æ–°å±€å¼€å§‹ã€‚åº„å®¶ï¼ˆä½ ï¼Œå—å®¶ï¼‰14 å¼ ç‰Œï¼Œè¯·å…ˆå‡ºç‰Œã€‚');
            log(`å‰©ä½™ç‰Œæ•°: ${state.wall.length}`);
            log('çº¢ä¸­å˜ç©æ³•ï¼šçº¢ä¸­å¯ä»¥ä½œä¸ºä¸‡èƒ½ç‰Œä½¿ç”¨ï¼Œä½†ä¸èƒ½ç”¨äºç¢°æˆ–æ ã€‚');
        }
        
        function sortHand(hand) {
            hand.sort((a, b) => {
                if (a.type !== b.type) {
                    return a.type === 'number' ? -1 : 1;
                }
                
                if (a.suit !== b.suit) {
                    return a.suit.localeCompare(b.suit);
                }
                
                if (a.type === 'honor') {
                    const honorOrder = {
                        'east': 1, 'south': 2, 'west': 3, 'north': 4,
                        'red': 5, 'green': 6, 'white': 7
                    };
                    return honorOrder[a.rank] - honorOrder[b.rank];
                }
                
                return a.rank - b.rank;
            });
        }
        
        function renderDiscards() {
            const el = document.getElementById('discards');
            el.innerHTML = '';
            
            for (const t of state.discards) {
                el.appendChild(renderDiscardTile(t));
            }
        }
        
        function renderMelds() {
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('melds-' + i);
                el.innerHTML = '';
                
                for (const meld of state.melds[i]) {
                    const meldEl = document.createElement('div');
                    meldEl.className = 'meld';
                    
                    for (const tile of meld.tiles) {
                        meldEl.appendChild(renderMeldTile(tile));
                    }
                    
                    el.appendChild(meldEl);
                }
            }
        }
        
        function updatePlayerHighlight() {
            for (let i = 0; i < 4; i++) {
                const scoreEl = document.getElementById('score-' + i);
                if (i === state.currentPlayer) {
                    scoreEl.classList.add('active');
                } else {
                    scoreEl.classList.remove('active');
                }
            }
        }
        
        function renderAll() {
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('hand-' + i);
                el.innerHTML = '';
                const isPlayer = (i === 0);
                
                // å¦‚æœæ˜¯å—ç©å®¶ï¼ˆç©å®¶è‡ªå·±ï¼‰ä¸”åœ¨æ‰‹æœºç«¯ï¼Œä½¿ç”¨æ»‘åŠ¨å¸ƒå±€
                if (isPlayer && isMobile) {
                    el.classList.add('mobile-slider');
                    
                    const hand = state.hands[i];
                    
                    for (let j = 0; j < hand.length; j++) {
                        const tile = hand[j];
                        let clickHandler;
                        
                        if (state.devMode) {
                            clickHandler = () => {
                                if (state.devMode) {
                                    const removedTile = state.hands[0].splice(j, 1)[0];
                                    state.wall.push(removedTile);
                                    renderAll();
                                    checkWinCondition(0);
                                    checkTingPai();
                                    log(`å¼€å‘è€…æ¨¡å¼ï¼šç§»é™¤ ${tileToChinese(tile)} å¹¶æ”¾å›ç‰Œåº“`);
                                } else {
                                    onPlayerTileClick(j);
                                }
                            };
                        } else {
                            clickHandler = () => onPlayerTileClick(j);
                        }
                        
                        const node = renderTile(tile, {click: clickHandler});
                        el.appendChild(node);
                    }
                } else {
                    // éæ‰‹æœºç«¯æˆ–å…¶ä»–ç©å®¶çš„æ‰‹ç‰Œä¿æŒåŸæ ·
                    el.classList.remove('mobile-slider');
                    
                    for (let j = 0; j < state.hands[i].length; j++) {
                        const tile = state.hands[i][j];
                        let clickHandler;
                        
                        if (isPlayer) {
                            if (state.devMode) {
                                clickHandler = () => {
                                    if (state.devMode) {
                                        const removedTile = state.hands[0].splice(j, 1)[0];
                                        state.wall.push(removedTile);
                                        renderAll();
                                        checkWinCondition(0);
                                        checkTingPai();
                                        log(`å¼€å‘è€…æ¨¡å¼ï¼šç§»é™¤ ${tileToChinese(tile)} å¹¶æ”¾å›ç‰Œåº“`);
                                    } else {
                                        onPlayerTileClick(j);
                                    }
                                };
                            } else {
                                clickHandler = () => onPlayerTileClick(j);
                            }
                        }
                        
                        const node = isPlayer ? 
                            renderTile(tile, {click: clickHandler}) : 
                            renderTile(tile, {back: true, aiPlayer: true});
                        el.appendChild(node);
                    }
                }
            }
            
            renderDiscards();
            renderMelds();
            
            for (let i = 0; i < 4; i++) {
                document.getElementById('score-' + i).textContent = 
                    `${PLAYER_NAMES[i]}ï¼š${state.scores[i]}`;
            }
            
            updatePlayerHighlight();
        }
        
        function hideActionButtons() {
            pengBtn.style.display = 'none';
            gangBtn.style.display = 'none';
            skipBtn.style.display = 'none';
            state.availableActions = { peng: false, gang: false, gangAfterDraw: false, gangType: null, gangTile: null };
        }
        
        function showActionButtons() {
            if (state.availableActions.peng) {
                pengBtn.style.display = 'block';
            }
            if (state.availableActions.gang || state.availableActions.gangAfterDraw) {
                gangBtn.style.display = 'block';
            }
            skipBtn.style.display = 'block';
        }
        
        function onPlayerTileClick(index) {
            if (state.currentPlayer !== 0) {
                log('ä¸æ˜¯ä½ çš„å›åˆ');
                return;
            }
            
            if (!state.waitingForDiscard) {
                log('ä½ ä¸èƒ½å†å‡ºç‰Œ');
                return;
            }
            
            const t = state.hands[0].splice(index, 1)[0];
            state.discards.push(t);
            state.lastDiscard = t;
            state.lastDiscardPlayer = 0;
            state.waitingForDiscard = false;
            
            state.newDrawTileId = null;
            
            if (state.firstTurn) {
                state.firstTurn = false;
            }
            
            log('ä½ æ‰“å‡ºï¼š' + tileToChinese(t));
            renderAll();
            checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
            
            processPendingActions();
        }
        
        function checkPeng(playerIndex, tile) {
            if (playerIndex === state.lastDiscardPlayer) return false;
            
            const hand = state.hands[playerIndex];
            let count = 0;
            
            for (const t of hand) {
                if (state.redDragonWildcard && t.type === 'honor' && t.rank === 'red') {
                    continue;
                }
                
                if (t.suit === tile.suit && t.rank === tile.rank) {
                    count++;
                }
            }
            
            return count >= 2;
        }
        
        function checkGang(playerIndex, tile) {
            if (playerIndex === state.lastDiscardPlayer) return false;
            
            const hand = state.hands[playerIndex];
            let count = 0;
            
            for (const t of hand) {
                if (state.redDragonWildcard && t.type === 'honor' && t.rank === 'red') {
                    continue;
                }
                
                if (t.suit === tile.suit && t.rank === tile.rank) {
                    count++;
                }
            }
            
            return count >= 3;
        }
        
        function checkGangAfterDraw(playerIndex) {
            const hand = state.hands[playerIndex];
            const melds = state.melds[playerIndex];
            
            const tileCounts = {};
            for (const tile of hand) {
                if (state.redDragonWildcard && tile.type === 'honor' && tile.rank === 'red') {
                    continue;
                }
                
                const id = tileId(tile);
                tileCounts[id] = (tileCounts[id] || 0) + 1;
            }
            
            for (const id in tileCounts) {
                if (tileCounts[id] === 4) {
                    for (const tile of hand) {
                        if (tileId(tile) === id) {
                            return {
                                canGang: true,
                                gangType: 'angang',
                                tile: tile
                            };
                        }
                    }
                }
            }
            
            for (const meld of melds) {
                if (meld.type === 'peng') {
                    const meldTile = meld.tiles[0];
                    for (const tile of hand) {
                        if (state.redDragonWildcard && tile.type === 'honor' && tile.rank === 'red') {
                            continue;
                        }
                        
                        if (tile.suit === meldTile.suit && tile.rank === meldTile.rank) {
                            return {
                                canGang: true,
                                gangType: 'jiagang',
                                tile: tile,
                                meldIndex: state.melds[playerIndex].indexOf(meld)
                            };
                        }
                    }
                }
            }
            
            return { canGang: false };
        }
        
        function doPeng(playerIndex) {
            const tile = state.lastDiscard;
            const hand = state.hands[playerIndex];
            
            let removed = 0;
            for (let i = hand.length - 1; i >= 0; i--) {
                if (hand[i].suit === tile.suit && hand[i].rank === tile.rank && removed < 2) {
                    hand.splice(i, 1);
                    removed++;
                }
            }
            
            const pengTiles = [
                {...tile},
                {...tile},
                {...tile}
            ];
            
            state.melds[playerIndex].push({
                type: 'peng',
                tiles: pengTiles,
                fromPlayer: state.lastDiscardPlayer
            });
            
            state.discards.pop();
            
            state.currentPlayer = playerIndex;
            state.waitingForDiscard = true;
            
            log(`${PLAYER_NAMES[playerIndex]} ç¢°äº† ${tileToChinese(tile)}`);
            renderAll();
            checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
            
            if (playerIndex === 0) {
                log('è¯·æ‰“å‡ºä¸€å¼ ç‰Œ');
            } else {
                setTimeout(() => {
                    const idx = Math.floor(Math.random() * state.hands[playerIndex].length);
                    const dt = state.hands[playerIndex].splice(idx, 1)[0];
                    state.discards.push(dt);
                    state.lastDiscard = dt;
                    state.lastDiscardPlayer = playerIndex;
                    state.waitingForDiscard = false;
                    
                    log(`${PLAYER_NAMES[playerIndex]} æ‰“å‡ºï¼š${tileToChinese(dt)}`);
                    renderAll();
                    checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                    processPendingActions();
                }, 1000);
            }
        }
        
        function doGang(playerIndex) {
            const tile = state.lastDiscard;
            const hand = state.hands[playerIndex];
            
            let removed = 0;
            for (let i = hand.length - 1; i >= 0; i--) {
                if (hand[i].suit === tile.suit && hand[i].rank === tile.rank && removed < 3) {
                    hand.splice(i, 1);
                    removed++;
                }
            }
            
            const gangTiles = [
                {...tile},
                {...tile},
                {...tile},
                {...tile}
            ];
            
            state.melds[playerIndex].push({
                type: 'gang',
                tiles: gangTiles,
                fromPlayer: state.lastDiscardPlayer,
                gangType: 'ming'
            });
            
            state.discards.pop();
            
            log(`${PLAYER_NAMES[playerIndex]} æ äº† ${tileToChinese(tile)}`);
            
            if (state.wall.length > 0) {
                const newTile = state.wall.pop();
                state.hands[playerIndex].push(newTile);
                sortHand(state.hands[playerIndex]);
                
                if (playerIndex === 0) {
                    state.newDrawTileId = newTile.id;
                }
                
                log(`${PLAYER_NAMES[playerIndex]} æ åæ‘¸ç‰Œ: ${tileToChinese(newTile)}`);
                log(`å‰©ä½™ç‰Œæ•°: ${state.wall.length}`);
            }
            
            state.currentPlayer = playerIndex;
            state.waitingForDiscard = true;
            renderAll();
            checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
            
            if (playerIndex === 0) {
                log('è¯·æ‰“å‡ºä¸€å¼ ç‰Œ');
            } else {
                setTimeout(() => {
                    const idx = Math.floor(Math.random() * state.hands[playerIndex].length);
                    const dt = state.hands[playerIndex].splice(idx, 1)[0];
                    state.discards.push(dt);
                    state.lastDiscard = dt;
                    state.lastDiscardPlayer = playerIndex;
                    state.waitingForDiscard = false;
                    
                    log(`${PLAYER_NAMES[playerIndex]} æ‰“å‡ºï¼š${tileToChinese(dt)}`);
                    renderAll();
                    checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                    processPendingActions();
                }, 1000);
            }
        }
        
        function doGangAfterDraw(playerIndex, gangType, tile, meldIndex = null) {
            const hand = state.hands[playerIndex];
            
            if (gangType === 'angang') {
                let removed = 0;
                for (let i = hand.length - 1; i >= 0; i--) {
                    if (hand[i].suit === tile.suit && hand[i].rank === tile.rank && removed < 4) {
                        hand.splice(i, 1);
                        removed++;
                    }
                }
                
                const gangTiles = [
                    {...tile},
                    {...tile},
                    {...tile},
                    {...tile}
                ];
                
                state.melds[playerIndex].push({
                    type: 'gang',
                    tiles: gangTiles,
                    fromPlayer: -1,
                    gangType: 'angang'
                });
                
                log(`${PLAYER_NAMES[playerIndex]} æš—æ  ${tileToChinese(tile)}`);
            } else if (gangType === 'jiagang') {
                let removed = 0;
                for (let i = hand.length - 1; i >= 0; i--) {
                    if (hand[i].suit === tile.suit && hand[i].rank === tile.rank && removed < 1) {
                        hand.splice(i, 1);
                        removed++;
                    }
                }
                
                const meld = state.melds[playerIndex][meldIndex];
                meld.type = 'gang';
                meld.gangType = 'jiagang';
                meld.tiles.push({...tile});
                
                log(`${PLAYER_NAMES[playerIndex]} åŠ æ  ${tileToChinese(tile)}`);
            }
            
            if (state.wall.length > 0) {
                const newTile = state.wall.pop();
                state.hands[playerIndex].push(newTile);
                sortHand(state.hands[playerIndex]);
                
                if (playerIndex === 0) {
                    state.newDrawTileId = newTile.id;
                }
                
                log(`${PLAYER_NAMES[playerIndex]} æ åæ‘¸ç‰Œ: ${tileToChinese(newTile)}`);
                log(`å‰©ä½™ç‰Œæ•°: ${state.wall.length}`);
            }
            
            state.currentPlayer = playerIndex;
            state.waitingForDiscard = true;
            renderAll();
            checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
            
            if (playerIndex === 0) {
                log('è¯·æ‰“å‡ºä¸€å¼ ç‰Œ');
            } else {
                setTimeout(() => {
                    const idx = Math.floor(Math.random() * state.hands[playerIndex].length);
                    const dt = state.hands[playerIndex].splice(idx, 1)[0];
                    state.discards.push(dt);
                    state.lastDiscard = dt;
                    state.lastDiscardPlayer = playerIndex;
                    state.waitingForDiscard = false;
                    
                    log(`${PLAYER_NAMES[playerIndex]} æ‰“å‡ºï¼š${tileToChinese(dt)}`);
                    renderAll();
                    checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                    processPendingActions();
                }, 1000);
            }
        }
        
        function skipAction() {
            if (state.hasActionBeenProcessed) return;
            state.hasActionBeenProcessed = true;
            
            hideActionPrompt();
            countdownEl.style.display = 'none';
            log('ä½ é€‰æ‹©è·³è¿‡åŠ¨ä½œ');
            
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
                state.countdownInterval = null;
            }
            
            state.skipPengGang = true;
            
            state.currentPlayer = (state.lastDiscardPlayer + 1) % 4;
            processPendingActionsAfterReaction();
        }
        
        function checkWinCondition(playerIndex) {
            const hand = [...state.hands[playerIndex]];
            
            if ((hand.length - 2) % 3 !== 0) return false;
            
            const n = (hand.length - 2) / 3;
            
            const counts = {};
            let redDragons = 0;
            
            for (const tile of hand) {
                if (state.redDragonWildcard && tile.type === 'honor' && tile.rank === 'red') {
                    redDragons++;
                } else {
                    const id = tileId(tile);
                    counts[id] = (counts[id] || 0) + 1;
                }
            }
            
            for (const id in counts) {
                if (counts[id] >= 2) {
                    const newCounts = {...counts};
                    newCounts[id] -= 2;
                    if (newCounts[id] === 0) delete newCounts[id];
                    
                    if (canFormMeldGroupsWithRedDragon(newCounts, redDragons, n)) {
                        return true;
                    }
                }
                
                if (counts[id] >= 1 && redDragons >= 1) {
                    const newCounts = {...counts};
                    newCounts[id] -= 1;
                    if (newCounts[id] === 0) delete newCounts[id];
                    
                    if (canFormMeldGroupsWithRedDragon(newCounts, redDragons - 1, n)) {
                        return true;
                    }
                }
            }
            
            if (redDragons >= 2) {
                if (canFormMeldGroupsWithRedDragon(counts, redDragons - 2, n)) {
                    return true;
                }
            }
            
            return false;
        }
        
        function processWin(playerIndex) {
            const playerName = PLAYER_NAMES[playerIndex];
            state.scores[playerIndex] += WIN_SCORE;
            
            hideWinPrompt();
            
            winMessageEl.querySelector('h2').textContent = `${playerName} èƒ¡ç‰Œäº†ï¼`;
            winMessageEl.querySelector('p:nth-child(2)').textContent = `${playerName} è·å¾— ${WIN_SCORE} åˆ†`;
            winMessageEl.querySelector('p:nth-child(3)').textContent = `å½“å‰å¾—åˆ†: ${state.scores.join(' | ')}`;
            winMessageEl.style.display = 'block';
            
            log(`ğŸ‰ ${playerName} èƒ¡ç‰Œäº†ï¼è·å¾— ${WIN_SCORE} åˆ†`);
            state.gameOver = true;
            
            // éšè—å¬ç‰Œä¿¡æ¯æ 
            tingPaiPanel.classList.remove('active');
        }
        
        function continueGame() {
            winMessageEl.style.display = 'none';
            reset();
        }
        
        function processPendingActions() {
            for (let i = 1; i < 4; i++) {
                if (checkWinCondition(i)) {
                    processWin(i);
                    return;
                }
            }
            
            if (state.lastDiscardPlayer !== -1 && state.lastDiscardPlayer !== 0) {
                const canPeng = checkPeng(0, state.lastDiscard);
                const canGang = checkGang(0, state.lastDiscard);
                
                if (canPeng || canGang) {
                    state.availableActions.peng = canPeng;
                    state.availableActions.gang = canGang;
                    state.availableActions.gangAfterDraw = false;
                    state.hasActionBeenProcessed = false;
                    state.skipPengGang = false;
                    
                    showActionButtons();
                    showActionPrompt();
                    log('ä½ å¯ä»¥é€‰æ‹©ç¢°æˆ–æ ï¼Œè¯·åœ¨10ç§’å†…å†³å®š');
                    
                    showCountdown();
                    
                    state.reactionTimer = setTimeout(() => {
                        hideActionButtons();
                        hideActionPrompt();
                        countdownEl.style.display = 'none';
                        state.isReacting = false;
                        skipAction();
                    }, REACTION_TIME);
                    
                    state.isReacting = true;
                    return;
                }
            }
            
            processPendingActionsAfterReaction();
        }
        
        function processPendingActionsAfterReaction() {
            for (let i = 1; i < 4; i++) {
                if (checkGang(i, state.lastDiscard)) {
                    if (Math.random() < 0.3) {
                        doGang(i);
                        return;
                    }
                }
            }
            
            for (let i = 1; i < 4; i++) {
                if (checkPeng(i, state.lastDiscard)) {
                    if (Math.random() < 0.5) {
                        doPeng(i);
                        return;
                    }
                }
            }
            
            nextTurn();
        }
        
        function nextTurn() {
            if (state.skipPengGang && state.lastDiscardPlayer !== -1) {
                state.skipPengGang = false;
                state.currentPlayer = (state.lastDiscardPlayer + 1) % 4;
                
                if (state.currentPlayer === 0) {
                    if (state.wall.length > 0) {
                        const t = state.wall.pop();
                        state.hands[0].push(t);
                        sortHand(state.hands[0]);
                        state.waitingForDiscard = true;
                        
                        state.newDrawTileId = t.id;
                        
                        log('ä½ æ‘¸åˆ°ä¸€å¼ ç‰Œï¼Œè¯·å‡ºç‰Œã€‚');
                        log(`å‰©ä½™ç‰Œæ•°: ${state.wall.length}`);
                        renderAll();
                        
                        if (checkWinCondition(0)) {
                            winBtn.disabled = false;
                            showWinPrompt();
                            log('ğŸ¯ ä½ å¯ä»¥èƒ¡ç‰Œäº†ï¼ç‚¹å‡»"èƒ¡ç‰Œ"æŒ‰é’®è·èƒœã€‚');
                        }
                        
                        checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                        
                        const gangCheck = checkGangAfterDraw(0);
                        if (gangCheck.canGang) {
                            state.availableActions.gangAfterDraw = true;
                            state.availableActions.gangType = gangCheck.gangType;
                            state.availableActions.gangTile = gangCheck.tile;
                            state.availableActions.meldIndex = gangCheck.meldIndex;
                            
                            showActionButtons();
                            showActionPrompt();
                            log(`ä½ å¯ä»¥${gangCheck.gangType === 'angang' ? 'æš—æ ' : 'åŠ æ '} ${tileToChinese(gangCheck.tile)}ï¼Œè¯·åœ¨10ç§’å†…å†³å®š`);
                            
                            showCountdown();
                            
                            state.reactionTimer = setTimeout(() => {
                                hideActionButtons();
                                hideActionPrompt();
                                countdownEl.style.display = 'none';
                                state.isReacting = false;
                                skipAction();
                            }, REACTION_TIME);
                            
                            state.isReacting = true;
                            return;
                        }
                    } else {
                        log('ç‰Œå¢™æ²¡äº†ï¼Œæµå±€ã€‚');
                        setTimeout(() => {
                            alert('ç‰Œå¢™å·²ç©ºï¼Œæµå±€ï¼');
                            reset();
                        }, 1000);
                    }
                    return;
                } else {
                    setTimeout(() => {
                        const t = state.wall.pop();
                        state.hands[state.currentPlayer].push(t);
                        sortHand(state.hands[state.currentPlayer]);
                        log(`${PLAYER_NAMES[state.currentPlayer]} æ‘¸ç‰Œ`);
                        log(`å‰©ä½™ç‰Œæ•°: ${state.wall.length}`);
                        
                        if (checkWinCondition(state.currentPlayer)) {
                            processWin(state.currentPlayer);
                            return;
                        }
                        
                        const gangCheck = checkGangAfterDraw(state.currentPlayer);
                        if (gangCheck.canGang && Math.random() < 0.5) {
                            doGangAfterDraw(state.currentPlayer, gangCheck.gangType, gangCheck.tile, gangCheck.meldIndex);
                            return;
                        }
                        
                        const idx = Math.floor(Math.random() * state.hands[state.currentPlayer].length);
                        const dt = state.hands[state.currentPlayer].splice(idx, 1)[0];
                        state.discards.push(dt);
                        state.lastDiscard = dt;
                        state.lastDiscardPlayer = state.currentPlayer;
                        state.waitingForDiscard = false;
                        
                        log(`${PLAYER_NAMES[state.currentPlayer]} æ‰“å‡ºï¼š${tileToChinese(dt)}`);
                        renderAll();
                        checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                        
                        setTimeout(processPendingActions, 700);
                    }, 700);
                    return;
                }
            }
            
            const playerOrder = [0, 1, 2, 3];
            const currentIndex = playerOrder.indexOf(state.currentPlayer);
            state.currentPlayer = playerOrder[(currentIndex + 1) % 4];
            
            if (state.wall.length === 0) {
                log('ç‰Œå¢™æ²¡äº†ï¼Œæµå±€ã€‚');
                setTimeout(() => {
                    alert('ç‰Œå¢™å·²ç©ºï¼Œæµå±€ï¼');
                    reset();
                }, 1000);
                return;
            }
            
            if (state.currentPlayer === 0) {
                const t = state.wall.pop();
                state.hands[0].push(t);
                sortHand(state.hands[0]);
                state.waitingForDiscard = true;
                
                state.newDrawTileId = t.id;
                
                log('ä½ æ‘¸åˆ°ä¸€å¼ ç‰Œï¼Œè¯·å‡ºç‰Œã€‚');
                log(`å‰©ä½™ç‰Œæ•°: ${state.wall.length}`);
                renderAll();
                
                if (checkWinCondition(0)) {
                    winBtn.disabled = false;
                    showWinPrompt();
                    log('ğŸ¯ ä½ å¯ä»¥èƒ¡ç‰Œäº†ï¼ç‚¹å‡»"èƒ¡ç‰Œ"æŒ‰é’®è·èƒœã€‚');
                }
                
                checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                
                const gangCheck = checkGangAfterDraw(0);
                if (gangCheck.canGang) {
                    state.availableActions.gangAfterDraw = true;
                    state.availableActions.gangType = gangCheck.gangType;
                    state.availableActions.gangTile = gangCheck.tile;
                    state.availableActions.meldIndex = gangCheck.meldIndex;
                    
                    showActionButtons();
                    showActionPrompt();
                    log(`ä½ å¯ä»¥${gangCheck.gangType === 'angang' ? 'æš—æ ' : 'åŠ æ '} ${tileToChinese(gangCheck.tile)}ï¼Œè¯·åœ¨10ç§’å†…å†³å®š`);
                    
                    showCountdown();
                    
                    state.reactionTimer = setTimeout(() => {
                        hideActionButtons();
                        hideActionPrompt();
                        countdownEl.style.display = 'none';
                        state.isReacting = false;
                        skipAction();
                    }, REACTION_TIME);
                    
                    state.isReacting = true;
                    return;
                }
                
                return;
            }
            
            setTimeout(() => {
                const t = state.wall.pop();
                state.hands[state.currentPlayer].push(t);
                sortHand(state.hands[state.currentPlayer]);
                log(`${PLAYER_NAMES[state.currentPlayer]} æ‘¸ç‰Œ`);
                log(`å‰©ä½™ç‰Œæ•°: ${state.wall.length}`);
                
                if (checkWinCondition(state.currentPlayer)) {
                    processWin(state.currentPlayer);
                    return;
                }
                
                const gangCheck = checkGangAfterDraw(state.currentPlayer);
                if (gangCheck.canGang && Math.random() < 0.5) {
                    doGangAfterDraw(state.currentPlayer, gangCheck.gangType, gangCheck.tile, gangCheck.meldIndex);
                    return;
                }
                
                const idx = Math.floor(Math.random() * state.hands[state.currentPlayer].length);
                const dt = state.hands[state.currentPlayer].splice(idx, 1)[0];
                state.discards.push(dt);
                state.lastDiscard = dt;
                state.lastDiscardPlayer = state.currentPlayer;
                state.waitingForDiscard = false;
                
                log(`${PLAYER_NAMES[state.currentPlayer]} æ‰“å‡ºï¼š${tileToChinese(dt)}`);
                renderAll();
                checkTingPai(); // æ£€æŸ¥å¬ç‰ŒçŠ¶æ€
                
                setTimeout(processPendingActions, 700);
            }, 700);
        }
        
        function initGame() {
            initDevPanelDrag();
            
            // æ·»åŠ è§¦æ‘¸æ”¯æŒ
            addTouchSupport();
            
            // è§„åˆ™æ¨¡æ€æ¡†äº‹ä»¶
            rulesBtn.addEventListener('click', showRules);
            closeRules.addEventListener('click', hideRules);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            rulesModal.addEventListener('click', function(e) {
                if (e.target === rulesModal) {
                    hideRules();
                }
            });
            
            // æŒ‰ESCé”®å…³é—­è§„åˆ™æ¨¡æ€æ¡†
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && rulesModal.style.display === 'flex') {
                    hideRules();
                }
            });
            
            startBtn.addEventListener('click', () => {
                reset();
            });
            
            winBtn.addEventListener('click', () => {
                if (checkWinCondition(0)) {
                    processWin(0);
                    winBtn.disabled = true;
                } else {
                    log('ä½ è¿˜æ²¡æœ‰èƒ¡ç‰Œï¼');
                }
            });
            
            pengBtn.addEventListener('click', () => {
                if (state.availableActions.peng) {
                    if (state.hasActionBeenProcessed) return;
                    state.hasActionBeenProcessed = true;
                    
                    if (state.reactionTimer) {
                        clearTimeout(state.reactionTimer);
                        state.reactionTimer = null;
                    }
                    
                    if (state.countdownInterval) {
                        clearInterval(state.countdownInterval);
                        state.countdownInterval = null;
                    }
                    
                    countdownEl.style.display = 'none';
                    hideActionPrompt();
                    
                    doPeng(0);
                    hideActionButtons();
                    state.isReacting = false;
                }
            });
            
            gangBtn.addEventListener('click', () => {
                if (state.availableActions.gang || state.availableActions.gangAfterDraw) {
                    if (state.hasActionBeenProcessed) return;
                    state.hasActionBeenProcessed = true;
                    
                    if (state.reactionTimer) {
                        clearTimeout(state.reactionTimer);
                        state.reactionTimer = null;
                    }
                    
                    if (state.countdownInterval) {
                        clearInterval(state.countdownInterval);
                        state.countdownInterval = null;
                    }
                    
                    countdownEl.style.display = 'none';
                    hideActionPrompt();
                    
                    if (state.availableActions.gangAfterDraw) {
                        // ä¿®å¤ï¼šç¡®ä¿ä¼ é€’æ­£ç¡®çš„å‚æ•°
                        doGangAfterDraw(0, state.availableActions.gangType, state.availableActions.gangTile, state.availableActions.meldIndex);
                    } else {
                        doGang(0);
                    }
                    
                    hideActionButtons();
                    state.isReacting = false;
                }
            });
            
            skipBtn.addEventListener('click', () => {
                if (state.reactionTimer) {
                    clearTimeout(state.reactionTimer);
                    state.reactionTimer = null;
                }
                
                if (state.countdownInterval) {
                    clearInterval(state.countdownInterval);
                    state.countdownInterval = null;
                }
                
                countdownEl.style.display = 'none';
                hideActionPrompt();
                
                skipAction();
                hideActionButtons();
                state.isReacting = false;
            });
            
            continueBtn.addEventListener('click', () => {
                continueGame();
            });
            
            devBtn.addEventListener('click', () => {
                toggleDevMode();
            });
            
            clearHandBtn.addEventListener('click', () => {
                clearPlayerHand();
            });
            
            testWinBtn.addEventListener('click', () => {
                testWinHand();
            });
            
            addRandomBtn.addEventListener('click', () => {
                addRandomTiles();
            });
            
            addRedDragonBtn.addEventListener('click', () => {
                addRedDragon();
            });
            
            log('æ¸¸æˆå·²å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ–°å±€"æŒ‰é’®å¼€å§‹æ¸¸æˆã€‚');
            log('ç‚¹å‡»"æ¸¸æˆè§„åˆ™"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†ç©æ³•è¯´æ˜ã€‚');
            log('çº¢ä¸­å˜ç©æ³•ï¼šçº¢ä¸­å¯ä»¥ä½œä¸ºä¸‡èƒ½ç‰Œä½¿ç”¨ï¼Œä½†ä¸èƒ½ç”¨äºç¢°æˆ–æ ã€‚');
        }
        
        initGame();
    </script>
</body>
</html>
