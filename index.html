<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麻将游戏 - 优化修复版</title>
    <style>
        :root {
            --player-tile-w: 52px;
            --player-tile-h: 76px;
            --ai-tile-w: 40px;
            --ai-tile-h: 58px;
            --discard-tile-w: 38px;
            --discard-tile-h: 56px;
            --meld-tile-w: 34px;
            --meld-tile-h: 48px;
            --gap: 8px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            background: #0b5f3c;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 10px;
        }
        
        header {
            padding: 12px;
            text-align: center;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .main-container {
            display: flex;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
        }
        
        .table-section {
            flex: 4;
            display: flex;
            justify-content: center;
        }
        
        .table-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .table {
            width: 100%;
            height: 900px;
            background: linear-gradient(180deg, #1b6b49, #0b4f36);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            border: 3px solid #d4af37;
        }
        
        .info-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-width: 280px;
            max-width: 350px;
        }
        
        .scoreboard {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .player-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .player-box.active {
            background: rgba(255, 215, 107, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 107, 0.5);
        }
        
        .hand {
            display: flex;
            gap: var(--gap);
            align-items: end;
        }
        
        .hand.vertical {
            flex-direction: column;
            align-items: center;
        }
        
        .tile {
            width: var(--player-tile-w);
            height: var(--player-tile-h);
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: 111;
            font-weight: 700;
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .tile:hover {
            transform: translateY(-4px);
        }
        
        .tile .num {
            font-size: 18px;
            color: #000;
        }
        
        .tile .suit {
            font-size: 11px;
            color: #b00;
        }
        
        .tile.honor {
            font-size: 20px;
            color: #000;
        }
        
        .tile.discarded {
            opacity: 0.7;
        }
        
        .tile.available {
            box-shadow: 0 0 0 2px #ffd66b;
        }
        
        /* AI玩家牌墙样式 */
        .ai-tile {
            width: var(--ai-tile-w);
            height: var(--ai-tile-h);
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
        }
        
        .ai-tile .num {
            font-size: 14px;
        }
        
        .ai-tile .suit {
            font-size: 9px;
            color: #b00;
        }
        
        .ai-tile.honor {
            font-size: 16px;
            color: #000;
        }
        
        .discard-tile {
            width: var(--discard-tile-w);
            height: var(--discard-tile-h);
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
        }
        
        .discard-tile .num {
            font-size: 14px;
        }
        
        .discard-tile .suit {
            font-size: 9px;
            color: #b00;
        }
        
        .discard-tile.honor {
            font-size: 16px;
            color: #000;
        }
        
        .meld {
            display: flex;
            gap: 2px;
            margin: 4px 0;
        }
        
        .meld-tile {
            width: var(--meld-tile-w);
            height: var(--meld-tile-h);
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #111;
            font-weight: 700;
        }
        
        .meld-tile .num {
            font-size: 12px;
            transform: none !important;
        }
        
        .meld-tile .suit {
            font-size: 8px;
            color: #b00;
            transform: none !important;
        }
        
        .meld-tile.honor {
            font-size: 14px;
            color: #000;
        }
        
        .melds-container {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-top: 8px;
            position: absolute;
            z-index: 5;
        }
        
        /* 玩家碰杠牌位置 */
        #melds-0 {
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #melds-1 {
            top: 50%;
            right: 120px;
            transform: translateY(-50%);
            flex-direction: column;
        }
        
        #melds-2 {
            top: 50%;
            left: 120px;
            transform: translateY(-50%);
            flex-direction: column;
        }
        
        #melds-3 {
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .back {
            background: #999;
        }
        
        .controls {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: #ffd66b;
            color: #111;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            font-size: 14px;
        }
        
        button:hover {
            background: #ffc83d;
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        button.win {
            background: #ff6b6b;
            color: white;
        }
        
        button.win:hover {
            background: #ff5252;
        }
        
        button.action {
            background: #6bcaff;
            color: white;
        }
        
        button.action:hover {
            background: #52b0ff;
        }
        
        .info-panel {
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            margin-top: 15px;
        }
        
        .log {
            height: 100px;
            overflow: auto;
            background: rgba(255, 255, 255, 0.08);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .log p {
            margin: 4px 0;
            line-height: 1.3;
        }
        
        .pile {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 55px;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .seat {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .seat.top {
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: column;
        }
        
        .seat.bottom {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: column;
        }
        
        .seat.left {
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
        }
        
        .seat.right {
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            flex-direction: column;
        }
        
        .seat.left .hand,
        .seat.right .hand {
            flex-direction: column;
            align-items: center;
        }
        
        .seat.left .ai-tile,
        .seat.right .ai-tile {
            width: var(--ai-tile-h);
            height: var(--ai-tile-w);
        }
        
        .seat.left .ai-tile .num,
        .seat.right .ai-tile .num {
            transform: rotate(90deg);
        }
        
        .seat.left .ai-tile .suit,
        .seat.right .ai-tile .suit {
            transform: rotate(90deg);
        }
        
        .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }
        
        .center h4 {
            margin: 4px 0;
            color: #ffd;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            font-size: 14px;
        }
        
        .win-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(255, 215, 107, 0.7);
            border: 2px solid #ffd66b;
            display: none;
        }
        
        .win-message h2 {
            color: #ffd66b;
            margin-top: 0;
            font-size: 22px;
        }
        
        .win-message p {
            font-size: 16px;
            margin: 10px 0;
        }
        
        .win-message button {
            margin-top: 10px;
            padding: 10px 18px;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 8px;
        }
        
        .countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #ffd66b;
            font-size: 36px;
            font-weight: bold;
            padding: 15px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(255, 215, 107, 0.4);
            display: none;
        }
        
        .action-prompt {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 0 15px rgba(255, 215, 107, 0.5);
            border: 2px solid #ffd66b;
            color: #ffd66b;
            font-weight: bold;
            display: none;
        }
        
        /* 响应式设计 */
        @media (max-width: 1400px) {
            .main-container {
                flex-direction: column;
            }
            
            .info-section {
                order: 2;
                width: 100%;
                max-width: 800px;
                margin: 0 auto;
            }
            
            .table-section {
                order: 1;
                width: 100%;
            }
            
            .table-container {
                width: 95%;
            }
            
            .scoreboard {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .player-box {
                min-width: 120px;
            }
        }
        
        @media (max-width: 1000px) {
            :root {
                --player-tile-w: 46px;
                --player-tile-h: 68px;
                --ai-tile-w: 36px;
                --ai-tile-h: 52px;
                --discard-tile-w: 34px;
                --discard-tile-h: 48px;
                --meld-tile-w: 30px;
                --meld-tile-h: 42px;
                --gap: 6px;
            }
            
            .table {
                height: 800px;
                padding: 25px;
            }
            
            #melds-1 {
                right: 90px;
            }
            
            #melds-2 {
                left: 90px;
            }
            
            .player-box {
                min-width: 110px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 800px) {
            :root {
                --player-tile-w: 40px;
                --player-tile-h: 60px;
                --ai-tile-w: 32px;
                --ai-tile-h: 46px;
                --discard-tile-w: 30px;
                --discard-tile-h: 42px;
                --meld-tile-w: 26px;
                --meld-tile-h: 38px;
                --gap: 5px;
            }
            
            .table {
                height: 700px;
                padding: 20px;
            }
            
            .player-box {
                min-width: 90px;
                padding: 6px 10px;
                font-size: 13px;
            }
            
            button {
                padding: 6px 10px;
                font-size: 13px;
            }
            
            #melds-1 {
                right: 75px;
            }
            
            #melds-2 {
                left: 75px;
            }
            
            .countdown {
                font-size: 30px;
                width: 50px;
                height: 50px;
            }
        }
        
        @media (max-width: 600px) {
            :root {
                --player-tile-w: 36px;
                --player-tile-h: 54px;
                --ai-tile-w: 28px;
                --ai-tile-h: 40px;
                --discard-tile-w: 28px;
                --discard-tile-h: 40px;
                --meld-tile-w: 24px;
                --meld-tile-h: 34px;
                --gap: 4px;
            }
            
            .table {
                height: 600px;
                padding: 15px;
            }
            
            .player-box {
                min-width: 80px;
                padding: 5px 8px;
                font-size: 12px;
            }
            
            button {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            #melds-1 {
                right: 60px;
            }
            
            #melds-2 {
                left: 60px;
            }
            
            .countdown {
                font-size: 24px;
                width: 40px;
                height: 40px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>麻将游戏 - 优化修复版</h1>
        <p>修复碰杠逻辑，调整玩家位置</p>
    </header>
    
    <div class="main-container">
        <div class="table-section">
            <div class="table-container">
                <div class="table">
                    <!-- 顶部玩家改为北 -->
                    <div class="seat top">
                        <div>北</div>
                        <div id="hand-2" class="hand"></div>
                        <div id="melds-2" class="melds-container"></div>
                    </div>
                    
                    <div class="seat bottom">
                        <div>南（你）</div>
                        <div id="hand-0" class="hand"></div>
                        <div id="melds-0" class="melds-container"></div>
                    </div>
                    
                    <!-- 左侧玩家改为西 -->
                    <div class="seat left">
                        <div>西</div>
                        <div id="hand-3" class="hand vertical"></div>
                        <div id="melds-3" class="melds-container"></div>
                    </div>
                    
                    <div class="seat right">
                        <div>东</div>
                        <div id="hand-1" class="hand vertical"></div>
                        <div id="melds-1" class="melds-container"></div>
                    </div>
                    
                    <div class="center">
                        <h4>弃牌堆</h4>
                        <div id="discards" class="pile"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-section">
            <div class="scoreboard">
                <div class="player-box" id="score-0">南（你）：0</div>
                <div class="player-box" id="score-1">东：0</div>
                <div class="player-box" id="score-2">北：0</div>
                <div class="player-box" id="score-3">西：0</div>
            </div>
            
            <div class="info-panel">
                <div class="controls">
                    <button id="btn-start">开始新局</button>
                    <button id="btn-win" class="win" disabled>胡牌</button>
                    <button id="btn-peng" class="action" style="display: none;">碰</button>
                    <button id="btn-gang" class="action" style="display: none;">杠</button>
                    <button id="btn-skip" class="action" style="display: none;">跳过</button>
                </div>
                <div class="log" id="log">
                    <p>游戏已就绪，点击"开始新局"按钮开始游戏。</p>
                </div>
            </div>
        </div>
    </div>

    <div id="win-message" class="win-message">
        <h2>玩家 胡牌了！</h2>
        <p>玩家 获得 10 分</p>
        <p>当前得分: 0 | 0 | 0 | 0</p>
        <button id="btn-continue">继续游戏</button>
    </div>

    <div id="countdown" class="countdown">5</div>
    <div id="action-prompt" class="action-prompt">请选择动作（5秒后自动跳过）</div>

    <script>
        // 游戏常量 - 玩家名称顺序为南、东、北、西
        const PLAYER_NAMES = ['南（你）', '东', '北', '西'];
        const WIN_SCORE = 10;
        const REACTION_TIME = 5000; // 5秒反应时间
        
        // 游戏状态
        const state = {
            wall: [],
            hands: [[], [], [], []],
            melds: [[], [], [], []], // 存储每个玩家的碰杠牌组
            discards: [],
            currentPlayer: 0,
            lastDiscard: null,
            lastDiscardPlayer: -1,
            scores: [0, 0, 0, 0],
            waitingForDiscard: false,
            firstTurn: true,
            gameOver: false,
            availableActions: {
                peng: false,
                gang: false
            },
            reactionTimer: null,
            countdown: 5,
            isReacting: false, // 标记是否正在等待玩家反应
            pendingAction: null, // 存储待处理的动作
            countdownInterval: null // 存储倒计时interval
        };
        
        // DOM元素
        const logEl = document.getElementById('log');
        const winBtn = document.getElementById('btn-win');
        const startBtn = document.getElementById('btn-start');
        const pengBtn = document.getElementById('btn-peng');
        const gangBtn = document.getElementById('btn-gang');
        const skipBtn = document.getElementById('btn-skip');
        const continueBtn = document.getElementById('btn-continue');
        const countdownEl = document.getElementById('countdown');
        const promptEl = document.getElementById('action-prompt');
        const winMessageEl = document.getElementById('win-message');
        
        // 生成所有麻将牌（136张）
        function makeAllTiles() {
            const suits = ['m', 'p', 's']; // 万、筒、条
            const honors = ['east', 'south', 'west', 'north', 'red', 'green', 'white']; // 字牌
            const tiles = [];
            
            // 添加序数牌（108张）
            for (const s of suits) {
                for (let r = 1; r <= 9; r++) {
                    for (let c = 0; c < 4; c++) {
                        tiles.push({suit: s, rank: r, type: 'number'});
                    }
                }
            }
            
            // 添加字牌（28张）
            for (const h of honors) {
                for (let c = 0; c < 4; c++) {
                    tiles.push({suit: 'z', rank: h, type: 'honor'});
                }
            }
            
            return tiles;
        }
        
        // 获取牌的ID
        function tileId(t) {
            return t.suit + (t.type === 'number' ? t.rank : t.rank.charAt(0));
        }
        
        // 将牌转换为中文描述
        function tileToChinese(t) {
            if (t.type === 'honor') {
                const honorMap = {
                    'east': '东',
                    'south': '南',
                    'west': '西',
                    'north': '北',
                    'red': '中',
                    'green': '发',
                    'white': '白'
                };
                return honorMap[t.rank];
            }
            
            const suitMap = {
                'm': '万',
                'p': '筒',
                's': '条'
            };
            
            const numMap = {
                1: '一',
                2: '二',
                3: '三',
                4: '四',
                5: '五',
                6: '六',
                7: '七',
                8: '八',
                9: '九'
            };
            
            return numMap[t.rank] + suitMap[t.suit];
        }
        
        // 洗牌
        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        
        // 渲染单张牌
        function renderTile(t, opts = {}) {
            const el = document.createElement('div');
            el.className = opts.aiPlayer ? 'ai-tile' : 'tile';
            if (opts.back) el.classList.add('back');
            if (opts.discarded) el.classList.add('discarded');
            if (opts.available) el.classList.add('available');
            
            if (!opts.back) {
                if (t.type === 'honor') {
                    el.classList.add('honor');
                    el.textContent = tileToChinese(t);
                } else {
                    const num = document.createElement('div');
                    num.className = 'num';
                    num.textContent = t.rank;
                    
                    const suit = document.createElement('div');
                    suit.className = 'suit';
                    suit.innerHTML = (t.suit === 'm' ? '万' : t.suit === 'p' ? '筒' : '条');
                    
                    el.appendChild(num);
                    el.appendChild(suit);
                }
            }
            
            if (opts.click) el.addEventListener('click', opts.click);
            
            return el;
        }
        
        // 渲染碰杠牌
        function renderMeldTile(t) {
            const el = document.createElement('div');
            el.className = 'meld-tile';
            
            if (t.type === 'honor') {
                el.classList.add('honor');
                el.textContent = tileToChinese(t);
            } else {
                const num = document.createElement('div');
                num.className = 'num';
                num.textContent = t.rank;
                
                const suit = document.createElement('div');
                suit.className = 'suit';
                suit.innerHTML = (t.suit === 'm' ? '万' : t.suit === 'p' ? '筒' : '条');
                
                el.appendChild(num);
                el.appendChild(suit);
            }
            
            return el;
        }
        
        // 渲染弃牌
        function renderDiscardTile(t) {
            const el = document.createElement('div');
            el.className = 'discard-tile';
            
            if (t.type === 'honor') {
                el.classList.add('honor');
                el.textContent = tileToChinese(t);
            } else {
                const num = document.createElement('div');
                num.className = 'num';
                num.textContent = t.rank;
                
                const suit = document.createElement('div');
                suit.className = 'suit';
                suit.innerHTML = (t.suit === 'm' ? '万' : t.suit === 'p' ? '筒' : '条');
                
                el.appendChild(num);
                el.appendChild(suit);
            }
            
            return el;
        }
        
        // 记录游戏日志
        function log(s) {
            const p = document.createElement('p');
            p.textContent = s;
            logEl.prepend(p);
            // 自动滚动到最新日志
            logEl.scrollTop = 0;
        }
        
        // 显示倒计时
        function showCountdown() {
            state.countdown = 5;
            countdownEl.style.display = 'flex';
            countdownEl.textContent = state.countdown;
            
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
            }
            
            state.countdownInterval = setInterval(() => {
                state.countdown--;
                countdownEl.textContent = state.countdown;
                
                if (state.countdown <= 0) {
                    clearInterval(state.countdownInterval);
                    countdownEl.style.display = 'none';
                    state.countdown = 5;
                    // 时间到，自动跳过
                    hideActionButtons();
                    state.isReacting = false;
                    skipAction();
                }
            }, 1000);
        }
        
        // 显示动作提示
        function showActionPrompt() {
            promptEl.style.display = 'block';
        }
        
        // 隐藏动作提示
        function hideActionPrompt() {
            promptEl.style.display = 'none';
        }
        
        // 重置游戏状态
        function reset() {
            state.wall = shuffle(makeAllTiles());
            state.discards = [];
            state.lastDiscard = null;
            state.lastDiscardPlayer = -1;
            state.currentPlayer = 0;
            state.waitingForDiscard = true;
            state.firstTurn = true;
            state.gameOver = false;
            state.availableActions = { peng: false, gang: false };
            state.isReacting = false;
            state.pendingAction = null;
            state.countdown = 5;
            
            // 清除倒计时
            if (state.reactionTimer) {
                clearTimeout(state.reactionTimer);
                state.reactionTimer = null;
            }
            
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
                state.countdownInterval = null;
            }
            
            // 移除倒计时显示
            countdownEl.style.display = 'none';
            
            // 移除动作提示
            hideActionPrompt();
            
            // 隐藏赢牌消息
            winMessageEl.style.display = 'none';
            
            for (let i = 0; i < 4; i++) {
                state.hands[i] = [];
                state.melds[i] = [];
            }
            
            // 发牌
            for (let round = 0; round < 3; round++) {
                for (let p = 0; p < 4; p++) {
                    for (let k = 0; k < 4; k++) {
                        state.hands[p].push(state.wall.pop());
                    }
                }
            }
            
            // 每人再摸一张
            for (let p = 0; p < 4; p++) {
                state.hands[p].push(state.wall.pop());
            }
            
            // 庄家多摸一张
            state.hands[0].push(state.wall.pop());
            
            // 排序手牌
            for (let p = 0; p < 4; p++) {
                sortHand(state.hands[p]);
            }
            
            updatePlayerHighlight();
            renderAll();
            checkWinCondition(0);
            hideActionButtons();
            log('新局开始。庄家（你，南家）14 张牌，请先出牌。');
            log(`剩余牌数: ${state.wall.length}`);
        }
        
        // 排序手牌
        function sortHand(hand) {
            hand.sort((a, b) => {
                // 先按类型排序：数字牌在前，字牌在后
                if (a.type !== b.type) {
                    return a.type === 'number' ? -1 : 1;
                }
                
                // 同类型按花色排序
                if (a.suit !== b.suit) {
                    return a.suit.localeCompare(b.suit);
                }
                
                // 字牌按固定顺序排序
                if (a.type === 'honor') {
                    const honorOrder = {
                        'east': 1, 'south': 2, 'west': 3, 'north': 4,
                        'red': 5, 'green': 6, 'white': 7
                    };
                    return honorOrder[a.rank] - honorOrder[b.rank];
                }
                
                // 数字牌按点数排序
                return a.rank - b.rank;
            });
        }
        
        // 渲染弃牌堆
        function renderDiscards() {
            const el = document.getElementById('discards');
            el.innerHTML = '';
            for (const t of state.discards) {
                el.appendChild(renderDiscardTile(t));
            }
        }
        
        // 渲染碰杠牌组
        function renderMelds() {
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('melds-' + i);
                el.innerHTML = '';
                
                for (const meld of state.melds[i]) {
                    const meldEl = document.createElement('div');
                    meldEl.className = 'meld';
                    
                    for (const tile of meld.tiles) {
                        meldEl.appendChild(renderMeldTile(tile));
                    }
                    
                    el.appendChild(meldEl);
                }
            }
        }
        
        // 更新玩家高亮
        function updatePlayerHighlight() {
            for (let i = 0; i < 4; i++) {
                const scoreEl = document.getElementById('score-' + i);
                if (i === state.currentPlayer) {
                    scoreEl.classList.add('active');
                } else {
                    scoreEl.classList.remove('active');
                }
            }
        }
        
        // 渲染所有元素
        function renderAll() {
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('hand-' + i);
                el.innerHTML = '';
                const isPlayer = (i === 0);
                
                for (let j = 0; j < state.hands[i].length; j++) {
                    const tile = state.hands[i][j];
                    const node = isPlayer ? 
                        renderTile(tile, {click: () => onPlayerTileClick(j)}) : 
                        renderTile(tile, {back: true, aiPlayer: true});
                    el.appendChild(node);
                }
            }
            
            renderDiscards();
            renderMelds();
            
            for (let i = 0; i < 4; i++) {
                document.getElementById('score-' + i).textContent = 
                    `${PLAYER_NAMES[i]}：${state.scores[i]}`;
            }
            
            updatePlayerHighlight();
        }
        
        // 隐藏动作按钮
        function hideActionButtons() {
            pengBtn.style.display = 'none';
            gangBtn.style.display = 'none';
            skipBtn.style.display = 'none';
            state.availableActions = { peng: false, gang: false };
        }
        
        // 显示动作按钮
        function showActionButtons() {
            if (state.availableActions.peng) {
                pengBtn.style.display = 'block';
            }
            if (state.availableActions.gang) {
                gangBtn.style.display = 'block';
            }
            skipBtn.style.display = 'block';
        }
        
        // 玩家点击牌
        function onPlayerTileClick(index) {
            if (state.currentPlayer !== 0) {
                log('不是你的回合');
                return;
            }
            
            if (!state.waitingForDiscard) {
                log('你不能再出牌');
                return;
            }
            
            const t = state.hands[0].splice(index, 1)[0];
            state.discards.push(t);
            state.lastDiscard = t;
            state.lastDiscardPlayer = 0;
            state.waitingForDiscard = false;
            
            if (state.firstTurn) {
                state.firstTurn = false;
            }
            
            log('你打出：' + tileToChinese(t));
            renderAll();
            
            // 继续游戏流程
            processPendingActions();
        }
        
        // 检查是否可以碰
        function checkPeng(playerIndex, tile) {
            if (playerIndex === state.lastDiscardPlayer) return false; // 不能碰自己打出的牌
            
            const hand = state.hands[playerIndex];
            const tileIdStr = tileId(tile);
            let count = 0;
            
            for (const t of hand) {
                if (tileId(t) === tileIdStr) {
                    count++;
                }
            }
            
            return count >= 2; // 至少有两张相同的牌可以碰
        }
        
        // 检查是否可以杠
        function checkGang(playerIndex, tile) {
            if (playerIndex === state.lastDiscardPlayer) return false; // 不能杠自己打出的牌
            
            const hand = state.hands[playerIndex];
            const tileIdStr = tileId(tile);
            let count = 0;
            
            for (const t of hand) {
                if (tileId(t) === tileIdStr) {
                    count++;
                }
            }
            
            return count >= 3; // 至少有三张相同的牌可以杠
        }
        
        // 执行碰牌
        function doPeng(playerIndex) {
            const tile = state.lastDiscard;
            const tileIdStr = tileId(tile);
            const hand = state.hands[playerIndex];
            
            // 从手牌中移除两张相同的牌
            let removed = 0;
            for (let i = hand.length - 1; i >= 0; i--) {
                if (tileId(hand[i]) === tileIdStr && removed < 2) {
                    hand.splice(i, 1);
                    removed++;
                }
            }
            
            // 创建碰牌组
            const pengTiles = [
                {...tile},
                {...tile},
                {...tile}
            ];
            
            // 添加到碰牌组
            state.melds[playerIndex].push({
                type: 'peng',
                tiles: pengTiles,
                fromPlayer: state.lastDiscardPlayer
            });
            
            // 从弃牌堆移除最后一张牌（刚打出的牌）
            state.discards.pop();
            
            // 设置当前玩家
            state.currentPlayer = playerIndex;
            state.waitingForDiscard = true;
            
            log(`${PLAYER_NAMES[playerIndex]} 碰了 ${tileToChinese(tile)}`);
            renderAll();
            
            // 如果是玩家碰牌，等待玩家出牌
            if (playerIndex === 0) {
                log('请打出一张牌');
            } else {
                // AI出牌
                setTimeout(() => {
                    const idx = Math.floor(Math.random() * state.hands[playerIndex].length);
                    const dt = state.hands[playerIndex].splice(idx, 1)[0];
                    state.discards.push(dt);
                    state.lastDiscard = dt;
                    state.lastDiscardPlayer = playerIndex;
                    state.waitingForDiscard = false;
                    
                    log(`${PLAYER_NAMES[playerIndex]} 打出：${tileToChinese(dt)}`);
                    renderAll();
                    processPendingActions();
                }, 1000);
            }
        }
        
        // 执行杠牌
        function doGang(playerIndex) {
            const tile = state.lastDiscard;
            const tileIdStr = tileId(tile);
            const hand = state.hands[playerIndex];
            
            // 从手牌中移除三张相同的牌
            let removed = 0;
            for (let i = hand.length - 1; i >= 0; i--) {
                if (tileId(hand[i]) === tileIdStr && removed < 3) {
                    hand.splice(i, 1);
                    removed++;
                }
            }
            
            // 创建杠牌组
            const gangTiles = [
                {...tile},
                {...tile},
                {...tile},
                {...tile}
            ];
            
            // 添加到杠牌组
            state.melds[playerIndex].push({
                type: 'gang',
                tiles: gangTiles,
                fromPlayer: state.lastDiscardPlayer,
                gangType: 'ming'
            });
            
            // 从弃牌堆移除最后一张牌（刚打出的牌）
            state.discards.pop();
            
            log(`${PLAYER_NAMES[playerIndex]} 杠了 ${tileToChinese(tile)}`);
            
            // 杠牌后从牌墙摸一张牌
            if (state.wall.length > 0) {
                const newTile = state.wall.pop();
                state.hands[playerIndex].push(newTile);
                sortHand(state.hands[playerIndex]);
                
                log(`${PLAYER_NAMES[playerIndex]} 杠后摸牌: ${tileToChinese(newTile)}`);
                log(`剩余牌数: ${state.wall.length}`);
            }
            
            // 设置当前玩家
            state.currentPlayer = playerIndex;
            state.waitingForDiscard = true;
            renderAll();
            
            // 如果是玩家杠牌，等待玩家出牌
            if (playerIndex === 0) {
                log('请打出一张牌');
            } else {
                // AI出牌
                setTimeout(() => {
                    const idx = Math.floor(Math.random() * state.hands[playerIndex].length);
                    const dt = state.hands[playerIndex].splice(idx, 1)[0];
                    state.discards.push(dt);
                    state.lastDiscard = dt;
                    state.lastDiscardPlayer = playerIndex;
                    state.waitingForDiscard = false;
                    
                    log(`${PLAYER_NAMES[playerIndex]} 打出：${tileToChinese(dt)}`);
                    renderAll();
                    processPendingActions();
                }, 1000);
            }
        }
        
        // 跳过动作
        function skipAction() {
            hideActionPrompt();
            countdownEl.style.display = 'none';
            log('你选择跳过动作');
            processPendingActionsAfterReaction();
        }
        
        // 检查是否可以胡牌 - 3n+2模式
        function checkWinCondition(playerIndex) {
            const hand = [...state.hands[playerIndex]];
            if (hand.length % 3 !== 2) return false; // 必须是3n+2张牌
            
            // 统计每种牌的数量
            const counts = {};
            for (const tile of hand) {
                const id = tileId(tile);
                counts[id] = (counts[id] || 0) + 1;
            }
            
            // 尝试每种牌作为将牌
            for (const id in counts) {
                if (counts[id] >= 2) {
                    // 复制计数并移除将牌
                    const newCounts = {...counts};
                    newCounts[id] -= 2;
                    if (newCounts[id] === 0) delete newCounts[id];
                    
                    // 检查剩下的牌是否能组成顺子或刻子
                    if (canFormMeldGroups(newCounts, hand)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // 检查是否能组成顺子或刻子组合
        function canFormMeldGroups(counts, hand) {
            // 如果没有牌了，说明全部匹配成功
            if (Object.keys(counts).length === 0) return true;
            
            // 获取所有牌型
            const keys = Object.keys(counts);
            const firstKey = keys[0];
            
            // 解析牌型
            const suit = firstKey[0];
            const rank = firstKey.length > 1 ? parseInt(firstKey.slice(1)) : firstKey;
            
            // 检查刻子（三张相同的牌）
            if (counts[firstKey] >= 3) {
                const newCounts = {...counts};
                newCounts[firstKey] -= 3;
                if (newCounts[firstKey] === 0) delete newCounts[firstKey];
                
                if (canFormMeldGroups(newCounts, hand)) {
                    return true;
                }
            }
            
            // 检查顺子（同花色的连续三张牌）- 只适用于数字牌
            if (suit !== 'z' && rank <= 7) {
                const next1 = `${suit}${rank + 1}`;
                const next2 = `${suit}${rank + 2}`;
                
                if (counts[firstKey] > 0 && counts[next1] > 0 && counts[next2] > 0) {
                    const newCounts = {...counts};
                    newCounts[firstKey] -= 1;
                    newCounts[next1] -= 1;
                    newCounts[next2] -= 1;
                    
                    // 清除计数为0的键
                    for (const key of [firstKey, next1, next2]) {
                        if (newCounts[key] === 0) delete newCounts[key];
                    }
                    
                    if (canFormMeldGroups(newCounts, hand)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // 处理胡牌
        function processWin(playerIndex) {
            const playerName = PLAYER_NAMES[playerIndex];
            state.scores[playerIndex] += WIN_SCORE;
            
            // 显示胡牌消息
            winMessageEl.querySelector('h2').textContent = `${playerName} 胡牌了！`;
            winMessageEl.querySelector('p:nth-child(2)').textContent = `${playerName} 获得 ${WIN_SCORE} 分`;
            winMessageEl.querySelector('p:nth-child(3)').textContent = `当前得分: ${state.scores.join(' | ')}`;
            winMessageEl.style.display = 'block';
            
            log(`🎉 ${playerName} 胡牌了！获得 ${WIN_SCORE} 分`);
            state.gameOver = true;
        }
        
        // 继续游戏
        function continueGame() {
            winMessageEl.style.display = 'none';
            reset();
        }
        
        // 处理待定动作
        function processPendingActions() {
            // 检查其他玩家是否可以胡牌
            for (let i = 1; i < 4; i++) {
                if (checkWinCondition(i)) {
                    processWin(i);
                    return;
                }
            }
            
            // 检查真人玩家是否可以碰或杠
            if (state.lastDiscardPlayer !== -1 && state.lastDiscardPlayer !== 0) {
                const canPeng = checkPeng(0, state.lastDiscard);
                const canGang = checkGang(0, state.lastDiscard);
                
                if (canPeng || canGang) {
                    state.availableActions.peng = canPeng;
                    state.availableActions.gang = canGang;
                    
                    showActionButtons();
                    showActionPrompt();
                    log('你可以选择碰或杠，请在5秒内决定');
                    
                    // 显示倒计时
                    showCountdown();
                    
                    // 设置5秒后自动跳过
                    state.reactionTimer = setTimeout(() => {
                        hideActionButtons();
                        hideActionPrompt();
                        countdownEl.style.display = 'none';
                        state.isReacting = false;
                        skipAction();
                    }, REACTION_TIME);
                    
                    state.isReacting = true;
                    return;
                }
            }
            
            // 如果没有需要玩家反应的情况，继续处理
            processPendingActionsAfterReaction();
        }
        
        // 反应时间后的处理
        function processPendingActionsAfterReaction() {
            // 检查其他玩家是否可以杠
            for (let i = 1; i < 4; i++) {
                if (checkGang(i, state.lastDiscard)) {
                    // AI有30%的概率杠
                    if (Math.random() < 0.3) {
                        doGang(i);
                        return;
                    }
                }
            }
            
            // 检查其他玩家是否可以碰
            for (let i = 1; i < 4; i++) {
                if (checkPeng(i, state.lastDiscard)) {
                    // AI有50%的概率碰
                    if (Math.random() < 0.5) {
                        doPeng(i);
                        return;
                    }
                }
            }
            
            // 没有动作，进入下一回合
            nextTurn();
        }
        
        // 下一回合
        function nextTurn() {
            // 出牌顺序：南(0) -> 东(1) -> 北(2) -> 西(3)
            const playerOrder = [0, 1, 2, 3];
            const currentIndex = playerOrder.indexOf(state.currentPlayer);
            state.currentPlayer = playerOrder[(currentIndex + 1) % 4];
            
            if (state.wall.length === 0) {
                log('牌墙没了，流局。');
                setTimeout(() => {
                    alert('牌墙已空，流局！');
                    reset();
                }, 1000);
                return;
            }
            
            // 如果轮到玩家
            if (state.currentPlayer === 0) {
                const t = state.wall.pop();
                state.hands[0].push(t);
                sortHand(state.hands[0]);
                state.waitingForDiscard = true;
                
                log('你摸到一张牌，请出牌。');
                log(`剩余牌数: ${state.wall.length}`);
                renderAll();
                
                // 检查玩家是否可以胡牌
                if (checkWinCondition(0)) {
                    winBtn.disabled = false;
                    log('你可以胡牌了！点击"胡牌"按钮获胜。');
                }
                
                return;
            }
            
            // AI玩家的回合
            setTimeout(() => {
                // AI摸牌
                const t = state.wall.pop();
                state.hands[state.currentPlayer].push(t);
                sortHand(state.hands[state.currentPlayer]);
                log(`${PLAYER_NAMES[state.currentPlayer]} 摸牌`);
                log(`剩余牌数: ${state.wall.length}`);
                
                // 检查AI是否可以胡牌
                if (checkWinCondition(state.currentPlayer)) {
                    processWin(state.currentPlayer);
                    return;
                }
                
                // AI出牌 - 随机选择一张牌打出
                const idx = Math.floor(Math.random() * state.hands[state.currentPlayer].length);
                const dt = state.hands[state.currentPlayer].splice(idx, 1)[0];
                state.discards.push(dt);
                state.lastDiscard = dt;
                state.lastDiscardPlayer = state.currentPlayer;
                state.waitingForDiscard = false;
                
                log(`${PLAYER_NAMES[state.currentPlayer]} 打出：${tileToChinese(dt)}`);
                renderAll();
                
                // 继续下一回合
                setTimeout(processPendingActions, 700);
            }, 700);
        }
        
        // 初始化游戏
        function initGame() {
            startBtn.addEventListener('click', () => {
                reset();
            });
            
            winBtn.addEventListener('click', () => {
                if (checkWinCondition(0)) {
                    processWin(0);
                    winBtn.disabled = true;
                } else {
                    log('你还没有胡牌！');
                }
            });
            
            pengBtn.addEventListener('click', () => {
                if (state.availableActions.peng) {
                    // 清除倒计时
                    if (state.reactionTimer) {
                        clearTimeout(state.reactionTimer);
                        state.reactionTimer = null;
                    }
                    
                    if (state.countdownInterval) {
                        clearInterval(state.countdownInterval);
                        state.countdownInterval = null;
                    }
                    
                    // 移除倒计时显示
                    countdownEl.style.display = 'none';
                    
                    // 移除动作提示
                    hideActionPrompt();
                    
                    doPeng(0);
                    hideActionButtons();
                    state.isReacting = false;
                }
            });
            
            gangBtn.addEventListener('click', () => {
                if (state.availableActions.gang) {
                    // 清除倒计时
                    if (state.reactionTimer) {
                        clearTimeout(state.reactionTimer);
                        state.reactionTimer = null;
                    }
                    
                    if (state.countdownInterval) {
                        clearInterval(state.countdownInterval);
                        state.countdownInterval = null;
                    }
                    
                    // 移除倒计时显示
                    countdownEl.style.display = 'none';
                    
                    // 移除动作提示
                    hideActionPrompt();
                    
                    doGang(0);
                    hideActionButtons();
                    state.isReacting = false;
                }
            });
            
            skipBtn.addEventListener('click', () => {
                // 清除倒计时
                if (state.reactionTimer) {
                    clearTimeout(state.reactionTimer);
                    state.reactionTimer = null;
                }
                
                if (state.countdownInterval) {
                    clearInterval(state.countdownInterval);
                    state.countdownInterval = null;
                }
                
                // 移除倒计时显示
                countdownEl.style.display = 'none';
                
                // 移除动作提示
                hideActionPrompt();
                
                skipAction();
                hideActionButtons();
                state.isReacting = false;
            });
            
            continueBtn.addEventListener('click', () => {
                continueGame();
            });
            
            // 初始日志
            log('游戏已就绪，点击"开始新局"按钮开始游戏。');
        }
        
        // 启动游戏
        initGame();
    </script>
</body>
</html>